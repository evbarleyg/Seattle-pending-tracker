<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Seattle Housing Buyer Lens</title>
    <meta name="description" content="Interactive Seattle housing dashboard for buyers. Cross-filter neighborhood, property type, price bands, and sale timing using King County public record data." />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Seattle Housing Buyer Lens" />
    <meta property="og:description" content="Buyer-focused Seattle housing dashboard with dynamic filters, market KPIs, and row-level records." />
    <meta property="og:url" content="https://evbarleyg.github.io/Seattle-pending-tracker/" />
    <meta property="og:image" content="https://evbarleyg.github.io/Seattle-pending-tracker/assets/share-preview.svg" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Seattle Housing Buyer Lens" />
    <meta name="twitter:description" content="Interactive buyer dashboard for Seattle home sales and pricing pressure." />
    <meta name="twitter:image" content="https://evbarleyg.github.io/Seattle-pending-tracker/assets/share-preview.svg" />
    <link rel="icon" href="favicon.ico" sizes="16x16 32x32 48x48" />
    <link rel="icon" type="image/svg+xml" href="favicon.svg" sizes="any" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="apple-touch-icon" href="assets/ebg-icon.svg" />
    <meta name="theme-color" content="#1f5ea8" />
    <style>
      :root {
        --bg: #0a1220;
        --bg-elev: #111c2f;
        --bg-elev-2: #16243b;
        --line: #2a3e5f;
        --text: #ecf3ff;
        --muted: #9fb4d4;
        --primary: #4da6ff;
        --primary-2: #3dd59d;
        --warn: #e6b35a;
        --danger: #e6718c;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        background:
          radial-gradient(1100px 600px at -15% -25%, #17335f 0%, transparent 55%),
          radial-gradient(1000px 600px at 115% -15%, #4a1f59 0%, transparent 52%),
          var(--bg);
        color: var(--text);
        font-family: "Inter", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      }
      a { color: #95d0ff; text-decoration: none; }
      a:hover { text-decoration: underline; }
      .address-link {
        color: #2c6fc2;
        text-decoration: underline;
        text-underline-offset: 2px;
        font-weight: 600;
      }
      .address-link:hover {
        color: #1d57a0;
      }
      .ext-icon {
        margin-left: 4px;
        font-size: 11px;
        opacity: 0.85;
      }

      header {
        max-width: 1260px;
        margin: 0 auto;
        padding: 28px 22px 10px;
      }
      h1 {
        margin: 0;
        font-size: 34px;
        letter-spacing: 0.4px;
      }
      .subtitle {
        margin-top: 8px;
        color: var(--muted);
        font-size: 14px;
      }
      .status {
        margin-top: 8px;
        color: var(--muted);
        font-size: 12px;
      }

      .tabs {
        margin-top: 14px;
        display: inline-flex;
        border: 1px solid var(--line);
        border-radius: 999px;
        overflow: hidden;
        background: rgba(17, 28, 47, 0.88);
      }
      .tab {
        border: none;
        background: transparent;
        color: var(--muted);
        font-size: 13px;
        padding: 9px 14px;
        cursor: pointer;
      }
      .tab.active {
        color: #fff;
        background: linear-gradient(135deg, #275ea7, #2d8cb4);
      }
      .header-controls {
        margin-top: 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .theme-toggle {
        border: 1px solid var(--line);
        border-radius: 999px;
        padding: 7px 12px;
        font-size: 12px;
        color: #d8e9ff;
        background: rgba(17, 28, 47, 0.88);
        cursor: pointer;
      }

      .app {
        max-width: 1260px;
        margin: 0 auto;
        padding: 14px 22px 30px;
        display: grid;
        gap: 14px;
      }
      .panel {
        background: linear-gradient(180deg, rgba(17,28,47,0.96), rgba(13,22,36,0.95));
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 14px;
        box-shadow: 0 12px 28px rgba(0,0,0,0.34);
      }
      .panel h3 {
        margin: 0 0 10px;
        font-size: 18px;
      }

      .filters {
        display: grid;
        grid-template-columns: repeat(8, minmax(0, 1fr));
        gap: 10px;
      }
      .filters-wrap > summary {
        list-style: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .filters-wrap > summary::-webkit-details-marker {
        display: none;
      }
      .filters-wrap > summary h3 {
        margin: 0;
      }
      .filters-toggle {
        border: 1px solid var(--line);
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 12px;
        color: var(--muted);
        background: #0f1b2f;
      }
      .filters-wrap .label-open {
        display: none;
      }
      .filters-wrap .label-closed {
        display: inline;
      }
      .filters-wrap[open] .label-open {
        display: inline;
      }
      .filters-wrap[open] .label-closed {
        display: none;
      }
      .filters-body {
        margin-top: 10px;
        display: grid;
        gap: 8px;
      }
      .field label {
        display: block;
        margin-bottom: 4px;
        color: var(--muted);
        font-size: 12px;
      }
      select, input {
        width: 100%;
        color: var(--text);
        background: #0c1728;
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 8px 10px;
        font-size: 14px;
      }
      input[type="range"] {
        padding: 0;
        height: 24px;
        background: transparent;
        accent-color: #2f83dd;
      }
      .range-value {
        margin-top: 2px;
        font-size: 12px;
        color: var(--muted);
      }
      .multi-dd {
        position: relative;
      }
      .multi-dd > summary {
        list-style: none;
        cursor: pointer;
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 8px 10px;
        background: #0c1728;
        color: var(--text);
        font-size: 14px;
      }
      .multi-dd > summary::-webkit-details-marker {
        display: none;
      }
      .multi-dd[open] > summary {
        border-color: #3e83cc;
      }
      .multi-dd-panel {
        position: absolute;
        z-index: 25;
        inset: calc(100% + 6px) 0 auto;
        border: 1px solid var(--line);
        border-radius: 12px;
        background: #0f1b2f;
        box-shadow: 0 14px 30px rgba(0, 0, 0, 0.38);
        padding: 10px;
      }
      .multi-dd-actions {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        gap: 8px;
      }
      .mini-link {
        border: 1px solid #35547a;
        border-radius: 999px;
        background: #12233a;
        color: #dcecff;
        font-size: 11px;
        padding: 3px 8px;
        cursor: pointer;
      }
      .multi-dd-options {
        max-height: 260px;
        overflow: auto;
        display: grid;
        gap: 6px;
        padding-right: 2px;
      }
      .multi-opt {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: #d8e8ff;
      }
      .multi-opt input {
        width: auto;
      }
      .actions {
        grid-column: 1 / -1;
        display: flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
      }
      .btn {
        border: 1px solid #2f76c4;
        border-radius: 10px;
        padding: 6px 10px;
        font-size: 12px;
        line-height: 1.2;
        white-space: nowrap;
        color: #fff;
        background: linear-gradient(135deg, #21589d, #2b93ba);
        cursor: pointer;
      }
      .btn.alt {
        border-color: var(--line);
        background: #0c1728;
        color: #d3e5ff;
      }
      .summary {
        margin-top: 8px;
        color: var(--muted);
        font-size: 12px;
      }
      .chips {
        margin-top: 8px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid #35547a;
        background: #15253d;
        color: #d8e8ff;
        font-size: 12px;
      }
      .chip button {
        border: none;
        background: transparent;
        color: #9ec0e8;
        cursor: pointer;
      }

      .view { display: none; }
      .view.active { display: grid; gap: 14px; }

      .guide {
        margin: 0;
        padding-left: 18px;
        color: #dce9ff;
        display: grid;
        gap: 7px;
      }
      .insights {
        margin: 0;
        padding-left: 18px;
        display: grid;
        gap: 7px;
      }

      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(6, minmax(0, 1fr));
        gap: 10px;
      }
      .kpi {
        border: 1px solid var(--line);
        border-radius: 12px;
        background: linear-gradient(180deg, #122440, #0f1d33);
        padding: 10px;
        display: grid;
        gap: 6px;
      }
      .kpi .label {
        color: var(--muted);
        font-size: 12px;
      }
      .kpi .value {
        font-size: 22px;
      }
      .kpi .kbtn {
        justify-self: start;
        border: 1px solid #37567a;
        border-radius: 999px;
        padding: 3px 8px;
        font-size: 11px;
        color: #dcecff;
        background: #12233a;
        cursor: pointer;
      }
      .kpi .kbtn.active {
        border-color: #4eb2ff;
      }

      .two-col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }
      .chart {
        display: grid;
        gap: 8px;
      }
      .vchart {
        min-height: 280px;
        display: grid;
        grid-template-columns: 58px 1fr;
        gap: 10px;
      }
      .y-axis {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: flex-end;
        color: var(--muted);
        font-size: 11px;
        padding: 2px 0 18px;
      }
      .plot {
        border-left: 1px solid #2d4363;
        border-bottom: 1px solid #2d4363;
        padding: 6px 6px 0 8px;
        display: grid;
        grid-auto-flow: column;
        grid-auto-columns: minmax(64px, 1fr);
        gap: 8px;
        align-items: end;
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
      }
      .vbar {
        border: 1px solid #2d4363;
        border-radius: 10px 10px 0 0;
        background: #0f1b2f;
        color: #dce8ff;
        cursor: pointer;
        display: grid;
        grid-template-rows: 1fr auto auto;
        padding: 6px 4px 4px;
        min-height: 165px;
      }
      .vbar.active {
        border-color: #4eb2ff;
      }
      .vbar-track {
        align-self: end;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: end;
        justify-content: center;
      }
      .vbar-fill {
        display: block;
        width: 78%;
        border-radius: 8px 8px 0 0;
        background: linear-gradient(180deg, #56d1ff, #3d93ed);
        min-height: 6px;
      }
      .vbar-fill.warm {
        background: linear-gradient(180deg, #f3c366, #cc8536);
      }
      .vbar-month {
        margin-top: 6px;
        text-align: center;
        font-size: 12px;
        color: #dce8ff;
      }
      .vbar-value {
        margin-top: 2px;
        text-align: center;
        font-size: 12px;
        color: #b8cae4;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      .table-wrap {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      th, td {
        text-align: left;
        padding: 8px 6px;
        border-bottom: 1px solid rgba(42,62,95,0.78);
      }
      th {
        color: var(--muted);
        font-weight: 600;
      }
      .th-sort {
        appearance: none;
        border: none;
        background: transparent;
        color: inherit;
        font: inherit;
        font-weight: 600;
        padding: 0;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .th-sort.active {
        color: var(--text);
      }
      .sort-ind {
        font-size: 11px;
        opacity: 0.8;
      }
      tr.clickable { cursor: pointer; }
      tr.clickable:hover { background: rgba(56,92,147,0.16); }
      tr.clickable.active { background: rgba(78,178,255,0.17); }

      .mini-btn {
        border: 1px solid #35547a;
        border-radius: 999px;
        background: #12233a;
        color: #dcecff;
        font-size: 11px;
        padding: 2px 8px;
        cursor: pointer;
      }
      .mini-btn.active {
        border-color: #4eb2ff;
      }
      .mode {
        display: inline-block;
        border: 1px solid #35547a;
        border-radius: 999px;
        background: #15253d;
        color: #dcecff;
        font-size: 11px;
        padding: 2px 8px;
      }
      .heat {
        display: inline-block;
        min-width: 92px;
        border-radius: 8px;
        padding: 3px 6px;
      }

      .mono {
        font-family: "SFMono-Regular", Menlo, Consolas, monospace;
        font-size: 12px;
        background: #0b1526;
        border: 1px solid var(--line);
        border-radius: 10px;
        white-space: pre-wrap;
        padding: 10px;
      }
      .note {
        margin-top: 8px;
        color: var(--muted);
        font-size: 12px;
      }

      /* Light theme defaults for readability */
      body.light {
        --line: #c7d4e7;
        --text: #14233b;
        --muted: #516884;
        background:
          radial-gradient(1100px 600px at -15% -25%, #d7e7ff 0%, transparent 55%),
          radial-gradient(1000px 600px at 115% -15%, #efe2ff 0%, transparent 52%),
          #f3f8ff;
      }
      body.light a { color: #1f5ea8; }
      body.light .address-link {
        color: #1f5ea8;
      }
      body.light .address-link:hover {
        color: #17467e;
      }
      body.light .tabs {
        background: rgba(255, 255, 255, 0.88);
        border-color: #bfd0e6;
      }
      body.light .tab { color: #3c5777; }
      body.light .tab.active { color: #fff; }
      body.light .theme-toggle {
        color: #294768;
        background: rgba(255, 255, 255, 0.9);
        border-color: #bfd0e6;
      }
      body.light .panel {
        background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(248,252,255,0.96));
        border-color: #c6d4e5;
        box-shadow: 0 10px 24px rgba(26, 59, 102, 0.12);
      }
      body.light select,
      body.light input {
        color: #1a2f4a;
        background: #ffffff;
        border-color: #bccde2;
      }
      body.light .range-value { color: #516884; }
      body.light .multi-dd > summary {
        color: #1a2f4a;
        background: #ffffff;
        border-color: #bccde2;
      }
      body.light .multi-dd-panel {
        background: #ffffff;
        border-color: #c4d4e8;
        box-shadow: 0 12px 28px rgba(23, 60, 105, 0.16);
      }
      body.light .mini-link {
        border-color: #b9cce5;
        background: #eaf3ff;
        color: #214767;
      }
      body.light .multi-opt { color: #234261; }
      body.light .btn.alt {
        color: #274667;
        background: #ffffff;
        border-color: #b8cadf;
      }
      body.light .chip {
        background: #edf4ff;
        border-color: #c4d4ea;
        color: #244160;
      }
      body.light .chip button { color: #476a91; }
      body.light .filters-toggle {
        border-color: #bccde2;
        background: #ffffff;
        color: #4f6783;
      }
      body.light .guide,
      body.light .insights { color: #1f3552; }
      body.light .kpi {
        background: linear-gradient(180deg, #f7fbff, #edf5ff);
        border-color: #c8d7eb;
      }
      body.light .kpi .kbtn {
        background: #eaf3ff;
        border-color: #b9cde5;
        color: #244665;
      }
      body.light .plot {
        border-left-color: #c7d5e8;
        border-bottom-color: #c7d5e8;
      }
      body.light .vbar {
        background: #ffffff;
        border-color: #c7d5e8;
        color: #1f3855;
      }
      body.light .vbar-fill { background: linear-gradient(180deg, #42bde7, #2d80d7); }
      body.light .vbar-fill.warm { background: linear-gradient(180deg, #e3b24f, #c07b2f); }
      body.light .vbar-month { color: #1f3855; }
      body.light .vbar-value { color: #4a6586; }
      body.light th,
      body.light td { border-bottom-color: #d2deed; }
      body.light tr.clickable:hover { background: rgba(77, 133, 200, 0.12); }
      body.light tr.clickable.active { background: rgba(77, 166, 255, 0.17); }
      body.light .mini-btn {
        border-color: #b9cce5;
        background: #eaf3ff;
        color: #214767;
      }
      body.light .mode {
        border-color: #b9cce5;
        background: #edf4ff;
        color: #214767;
      }
      body.light .mono {
        background: #f7fbff;
        border-color: #c5d4e7;
      }

      @media (max-width: 1120px) {
        .filters { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        .kpi-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .two-col { grid-template-columns: 1fr; }
      }
      @media (max-width: 680px) {
        .filters { grid-template-columns: 1fr 1fr; }
        .kpi-grid { grid-template-columns: 1fr 1fr; }
        .header-controls {
          flex-direction: column;
          align-items: flex-start;
        }
        header {
          padding: 20px 14px 8px;
        }
        .app {
          padding: 10px 14px 20px;
        }
        h1 {
          font-size: 28px;
        }
        .vchart {
          min-height: 230px;
          grid-template-columns: 46px 1fr;
        }
        .plot {
          grid-auto-columns: minmax(56px, 1fr);
        }
        .multi-dd-panel {
          position: fixed;
          left: 14px;
          right: 14px;
          inset: auto 14px 14px;
          max-height: 50vh;
        }
      }
    </style>
  </head>
  <body class="light">
    <header>
      <h1>Seattle Housing Buyer Lens</h1>
      <div class="subtitle">Buyer-focused market view for Seattle. Built on public-record sales, with optional MLS fields when available. Every chart and metric can filter the entire dashboard.</div>
      <div class="header-controls">
        <div class="tabs" role="tablist">
          <button class="tab active" data-view="overview" role="tab">Overview</button>
          <button class="tab" data-view="charts" role="tab">Charts</button>
          <button class="tab" data-view="records" role="tab">Records</button>
          <button class="tab" data-view="data" role="tab">Data</button>
        </div>
        <button class="theme-toggle" id="themeToggle" type="button">Switch To Dark Mode</button>
      </div>
      <div class="status" id="datasetStatus">Initializing dataset...</div>
    </header>

    <main class="app">
      <section class="panel">
        <details class="filters-wrap" id="globalFilters">
          <summary>
            <h3>Global Filters</h3>
            <span class="filters-toggle">
              <span class="label-closed">Show Filters</span>
              <span class="label-open">Hide Filters</span>
            </span>
          </summary>
          <div class="filters-body">
            <div class="filters">
              <div class="field">
                <label for="fNeighborhoodSummary">Neighborhoods</label>
                <details class="multi-dd" id="fNeighborhood">
                  <summary id="fNeighborhoodSummary">All neighborhoods</summary>
                  <div class="multi-dd-panel">
                    <div class="multi-dd-actions">
                      <button class="mini-link" id="fNeighborhoodSelectAll" type="button">Select All</button>
                      <button class="mini-link" id="fNeighborhoodClear" type="button">Clear</button>
                    </div>
                    <div class="multi-dd-options" id="fNeighborhoodOptions"></div>
                  </div>
                </details>
              </div>
              <div class="field">
                <label for="fType">Property Type</label>
                <select id="fType"></select>
              </div>
              <div class="field">
                <label for="fMode">Data Mode</label>
                <select id="fMode">
                  <option value="All">All</option>
                  <option value="PUBLIC_PROXY">Public Proxy</option>
                  <option value="MLS_ENRICHED">MLS Enriched</option>
                </select>
              </div>
              <div class="field">
                <label for="fScope">Scope</label>
                <select id="fScope">
                  <option value="all">All Sales</option>
                  <option value="pending7">MLS Pending <= 7 Days</option>
                </select>
              </div>
              <div class="field">
                <label for="fMinClose">Min Close Price</label>
                <input id="fMinClose" type="range" />
                <div class="range-value" id="fMinCloseValue">$0</div>
              </div>
              <div class="field">
                <label for="fMaxClose">Max Close Price</label>
                <input id="fMaxClose" type="range" />
                <div class="range-value" id="fMaxCloseValue">$0</div>
              </div>
              <div class="field">
                <label for="fDateFrom">Sale Date From</label>
                <input id="fDateFrom" type="date" />
              </div>
              <div class="field">
                <label for="fDateTo">Sale Date To</label>
                <input id="fDateTo" type="date" />
              </div>
              <div class="actions">
                <button class="btn" id="exportCsvBtn" type="button">Export CSV</button>
                <button class="btn alt" id="resetBtn" type="button">Reset</button>
                <button class="btn alt" id="clearCrossBtn" type="button">Clear Cross-Filters</button>
              </div>
            </div>
            <div class="summary" id="filterSummary">No data loaded.</div>
            <div class="chips" id="activeChips"></div>
          </div>
        </details>
      </section>

      <section id="view-overview" class="view active">
        <section class="panel">
          <h3>How To Use This Dashboard</h3>
          <ul class="guide">
            <li>App opens with default filters set to <strong>Single Family</strong> and <strong>$1.1M-$1.4M</strong> so you can start with a focused buy-box view.</li>
            <li>Start with price/date filters to define your buy box, then click chart rows or table rows to drill down.</li>
            <li>Every interactive metric and chart item applies a cross-filter across all tabs.</li>
            <li>Use the chips row to remove individual cross-filters, or click Clear Cross-Filters.</li>
            <li>Public Proxy mode has real close prices and assessed values, but not true original list/pending timestamps.</li>
            <li>MLS Enriched mode can add true list/pending/close timing when those fields are available.</li>
          </ul>
        </section>

        <div class="kpi-grid">
          <article class="kpi">
            <div class="label">Sales Count</div>
            <div class="value" id="kSales">0</div>
            <button class="kbtn" data-kpi-action="clear">Clear Cross-Filters</button>
          </article>
          <article class="kpi">
            <div class="label">Median Close Price</div>
            <div class="value" id="kMedianClose">$0</div>
            <button class="kbtn" data-kpi-action="closeTier">Filter Close >= Median</button>
          </article>
          <article class="kpi">
            <div class="label">Median Sale / Assessed</div>
            <div class="value" id="kMedianSA">0.00x</div>
            <button class="kbtn" data-kpi-action="ratioMid">Filter 1.00x - 1.05x</button>
          </article>
          <article class="kpi">
            <div class="label">Share Above Assessed</div>
            <div class="value" id="kAboveAssessed">0%</div>
            <button class="kbtn" data-kpi-action="ratioGt1">Filter S/A > 1.00x</button>
          </article>
          <article class="kpi">
            <div class="label">Median Price / SqFt</div>
            <div class="value" id="kPsf">$0</div>
            <button class="kbtn" data-kpi-action="psfTier">Filter $/SqFt >= Median</button>
          </article>
          <article class="kpi">
            <div class="label">Median Days To Pending (MLS, if available)</div>
            <div class="value" id="kPendingDays">n/a</div>
            <button class="kbtn" data-kpi-action="mlsOnly">Filter MLS Rows (if any)</button>
          </article>
        </div>

        <section class="panel">
          <h3>Current Slice Readout</h3>
          <ul class="insights" id="insights"></ul>
        </section>
      </section>

      <section id="view-charts" class="view">
        <div class="two-col">
          <section class="panel">
            <h3>Monthly Sales Volume</h3>
            <div class="chart" id="chartVolume"></div>
          </section>
          <section class="panel">
            <h3>Monthly Median Close Price</h3>
            <div class="chart" id="chartMedian"></div>
          </section>
        </div>
        <div class="two-col">
          <section class="panel">
            <h3>Sale / Assessed Buckets</h3>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr><th>Bucket</th><th>Count</th><th>Share</th><th>Median Close</th></tr>
                </thead>
                <tbody id="ratioRows"></tbody>
              </table>
            </div>
          </section>
          <section class="panel">
            <h3>Neighborhood Leaderboard</h3>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr><th>Neighborhood</th><th>Count</th><th>Median Close</th><th>Median S/A</th></tr>
                </thead>
                <tbody id="rankRows"></tbody>
              </table>
            </div>
          </section>
        </div>
      </section>

      <section id="view-records" class="view">
        <section class="panel">
          <h3>Row-Level Summary</h3>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th><button class="th-sort" type="button" data-record-sort="address">Address <span class="sort-ind" data-sort-ind="address">&#8597;</span></button></th>
                  <th><button class="th-sort" type="button" data-record-sort="neighborhood">Neighborhood <span class="sort-ind" data-sort-ind="neighborhood">&#8597;</span></button></th>
                  <th><button class="th-sort" type="button" data-record-sort="type">Type <span class="sort-ind" data-sort-ind="type">&#8597;</span></button></th>
                  <th><button class="th-sort" type="button" data-record-sort="beds">Beds <span class="sort-ind" data-sort-ind="beds">&#8597;</span></button></th>
                  <th><button class="th-sort" type="button" data-record-sort="baths">Baths <span class="sort-ind" data-sort-ind="baths">&#8597;</span></button></th>
                  <th><button class="th-sort" type="button" data-record-sort="sqft">SqFt <span class="sort-ind" data-sort-ind="sqft">&#8597;</span></button></th>
                  <th><button class="th-sort" type="button" data-record-sort="saleDate">Sale Date <span class="sort-ind" data-sort-ind="saleDate">&#8597;</span></button></th>
                  <th><button class="th-sort" type="button" data-record-sort="closePrice">Close Price <span class="sort-ind" data-sort-ind="closePrice">&#8597;</span></button></th>
                  <th><button class="th-sort" type="button" data-record-sort="assessedValue">Assessed <span class="sort-ind" data-sort-ind="assessedValue">&#8597;</span></button></th>
                  <th><button class="th-sort" type="button" data-record-sort="saleToAssessed">S/A <span class="sort-ind" data-sort-ind="saleToAssessed">&#8597;</span></button></th>
                  <th><button class="th-sort" type="button" data-record-sort="delta">Delta vs List@Pending <span class="sort-ind" data-sort-ind="delta">&#8597;</span></button></th>
                  <th><button class="th-sort" type="button" data-record-sort="dataMode">Data Mode <span class="sort-ind" data-sort-ind="dataMode">&#8597;</span></button></th>
                </tr>
              </thead>
              <tbody id="recordRows"></tbody>
            </table>
          </div>
          <div class="note">Address links open Zillow search results. Heat gradients cap outliers using robust percentiles.</div>
        </section>
      </section>

      <section id="view-data" class="view">
        <section class="panel">
          <h3>Data Source</h3>
          <div class="note" id="uploadStatus">Auto-load enabled for the default dataset.</div>

          <p class="note">Auto-load filename:</p>
          <div class="mono">public_sales_proxy_all_prices_last6mo.csv</div>

          <p class="note">Minimum columns:</p>
          <div class="mono">id,address,type,closePrice</div>

          <p class="note">Recommended columns:</p>
          <div class="mono">dataMode,neighborhood,typeCode,zip,listDate,pendingDate,saleDate,listPriceAtPending,assessedValue,beds,baths,sqft,yearBuilt,mlsListDate,mlsPendingDate,mlsListPriceAtPending,mlsClosePrice</div>

          <p class="note">Intended use:</p>
          <div class="mono">Buyer-side neighborhood and pricing-pressure analysis for Seattle. PUBLIC_PROXY mode uses public record fields. MLS_ENRICHED can add original listing timeline details when available.</div>
        </section>
      </section>
    </main>

    <script>
      const DEFAULT_DATASET = "public_sales_proxy_all_prices_last6mo.csv";
      const DEFAULT_MIN_CLOSE = 1100000;
      const DEFAULT_MAX_CLOSE = 1400000;
      const PRICE_SLIDER_MIN = 0;
      const PRICE_SLIDER_CAP = 3000000;
      const PRICE_SLIDER_STEP = 10000;

      const TYPE_LABELS = {
        "11": "Single Family",
        "12": "Multi-Family (2-4 Units)",
        "13": "Multi-Family (5+ Units)",
        "14": "Condo",
        "15": "Mobile home park/court",
        "18": "Other Residential",
        "19": "Vacation/cabin",
        "50": "Commercial / Non-Residential Condo",
        "91": "Land",
      };

      const ZIP_NEIGHBORHOOD = {
        "98101": "Downtown",
        "98102": "Capitol Hill / Eastlake",
        "98103": "Fremont / Green Lake / Wallingford",
        "98104": "Pioneer Square / International District",
        "98105": "University District / Laurelhurst",
        "98106": "Delridge / South Park",
        "98107": "Ballard",
        "98108": "Georgetown / South Park",
        "98109": "South Lake Union / Queen Anne",
        "98111": "Downtown",
        "98112": "Capitol Hill / Madison Park",
        "98115": "Ravenna / Wedgwood",
        "98116": "West Seattle",
        "98117": "Ballard / Crown Hill",
        "98118": "Columbia City / Rainier Valley",
        "98119": "Queen Anne / Magnolia",
        "98121": "Belltown",
        "98122": "Capitol Hill / Central District",
        "98124": "Downtown",
        "98125": "Lake City / North Seattle",
        "98126": "West Seattle / Delridge",
        "98133": "Northgate / Bitter Lake",
        "98134": "SoDo",
        "98136": "West Seattle / Fauntleroy",
        "98144": "Mount Baker / Central District",
        "98154": "Downtown",
        "98164": "Downtown",
        "98174": "Downtown",
        "98177": "North Beach / Crown Hill",
        "98194": "Downtown",
        "98199": "Magnolia",
      };

      const state = {
        rows: [],
        baseRows: [],
        filteredRows: [],
        recordSort: {
          key: "saleDate",
          dir: "desc",
        },
        interactions: {
          month: null,
          neighborhood: null,
          type: null,
          ratioBucket: null,
          mode: null,
          closeTier: null,
          psfTier: null,
        },
      };

      function esc(v) {
        return String(v ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function toDate(value) {
        if (!value) return null;
        const raw = String(value).trim();
        if (!raw) return null;
        const iso = /^\d{4}-\d{2}-\d{2}$/;
        const d = iso.test(raw) ? new Date(`${raw}T00:00:00`) : new Date(raw);
        return Number.isNaN(d.getTime()) ? null : d;
      }

      function toIso(value) {
        const d = toDate(value);
        if (!d) return "";
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
      }

      function num(v) {
        if (v === null || v === undefined || v === "") return 0;
        const n = Number(String(v).replace(/[^0-9.-]/g, ""));
        return Number.isFinite(n) ? n : 0;
      }

      function formatMoney(v) {
        return Number(v || 0).toLocaleString("en-US", {
          style: "currency",
          currency: "USD",
          maximumFractionDigits: 0,
        });
      }

      function median(values) {
        if (!values.length) return 0;
        const sorted = [...values].sort((a, b) => a - b);
        const mid = Math.floor(sorted.length / 2);
        return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
      }

      function quantile(values, q) {
        if (!values.length) return 0;
        const sorted = [...values].sort((a, b) => a - b);
        const pos = (sorted.length - 1) * q;
        const base = Math.floor(pos);
        const rest = pos - base;
        if (sorted[base + 1] !== undefined) {
          return sorted[base] + rest * (sorted[base + 1] - sorted[base]);
        }
        return sorted[base];
      }

      function monthKey(isoDate) {
        const d = toDate(isoDate);
        if (!d) return "Unknown";
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
      }

      function monthLabel(month) {
        const m = String(month || "");
        if (!/^\d{4}-\d{2}$/.test(m)) return m || "Unknown";
        const [yy, mm] = m.split("-");
        const d = new Date(`${yy}-${mm}-01T00:00:00`);
        if (Number.isNaN(d.getTime())) return m;
        return d.toLocaleString("en-US", { month: "short", year: "numeric" });
      }

      function daysBetween(a, b) {
        const d1 = toDate(a);
        const d2 = toDate(b);
        if (!d1 || !d2) return null;
        return Math.round((d2 - d1) / (1000 * 60 * 60 * 24));
      }

      function parseCsvLine(line) {
        const out = [];
        let cur = "";
        let inQuotes = false;
        for (let i = 0; i < line.length; i += 1) {
          const ch = line[i];
          if (ch === '"') {
            if (inQuotes && line[i + 1] === '"') {
              cur += '"';
              i += 1;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (ch === "," && !inQuotes) {
            out.push(cur.trim());
            cur = "";
          } else {
            cur += ch;
          }
        }
        out.push(cur.trim());
        return out;
      }

      function parseCsv(text) {
        const lines = text.trim().split(/\r?\n/);
        if (lines.length < 2) return [];
        const headers = parseCsvLine(lines[0]);
        const idx = Object.fromEntries(headers.map((h, i) => [h, i]));

        const required = ["id", "address", "type", "closePrice"];
        const missing = required.filter((k) => idx[k] === undefined);
        if (missing.length) throw new Error(`Missing required columns: ${missing.join(", ")}`);

        return lines.slice(1).filter((line) => line.trim()).map((line) => {
          const cols = parseCsvLine(line);
          const pick = (name) => (idx[name] !== undefined ? (cols[idx[name]] || "").trim() : "");
          return {
            dataMode: pick("dataMode"),
            id: pick("id"),
            address: pick("address"),
            neighborhood: pick("neighborhood"),
            type: pick("type"),
            typeCode: pick("typeCode"),
            listDate: pick("listDate"),
            pendingDate: pick("pendingDate"),
            saleDate: pick("saleDate"),
            listPriceAtPending: num(pick("listPriceAtPending")),
            closePrice: num(pick("closePrice")),
            assessedValue: num(pick("assessedValue")),
            beds: num(pick("beds")),
            baths: num(pick("baths")),
            sqft: num(pick("sqft")),
            yearBuilt: num(pick("yearBuilt")),
            zip: pick("zip"),
            mlsListDate: pick("mlsListDate"),
            mlsPendingDate: pick("mlsPendingDate"),
            mlsListPriceAtPending: num(pick("mlsListPriceAtPending")),
            mlsClosePrice: num(pick("mlsClosePrice")),
          };
        });
      }

      function titleCase(text) {
        return String(text || "")
          .toLowerCase()
          .replace(/\b\w/g, (m) => m.toUpperCase());
      }

      function inferMode(row) {
        if (row.dataMode) return row.dataMode;
        const hasMls = row.mlsListDate || row.mlsPendingDate || row.mlsListPriceAtPending || row.mlsClosePrice;
        return hasMls ? "MLS_ENRICHED" : "PUBLIC_PROXY";
      }

      function labelNeighborhood(rawNeighborhood, zip) {
        const raw = String(rawNeighborhood || "").trim();
        if (/[a-z]/i.test(raw)) return raw;
        const z = (String(zip || "").match(/[0-9]{5}/) || [])[0] || "";
        return ZIP_NEIGHBORHOOD[z] || "Seattle (Other)";
      }

      function labelType(rawType, typeCode) {
        const raw = String(rawType || "").trim();
        if (/[a-z]/i.test(raw)) {
          const pretty = /^[A-Z0-9\s,()\-]+$/.test(raw) ? titleCase(raw) : raw;
          const norm = pretty.toLowerCase();
          if (norm.includes("single family")) return "Single Family";
          if (norm.includes("condomini")) return "Condo";
          if (norm.includes("2-4 units")) return "Multi-Family (2-4 Units)";
          if (norm.includes("5+ units")) return "Multi-Family (5+ Units)";
          if (norm.includes("land")) return "Land";
          return pretty;
        }
        const code = String(num(typeCode || raw) || "");
        return TYPE_LABELS[code] || (code ? `Type ${code}` : "Unknown");
      }

      function normalizeForMatch(v) {
        return String(v || "").toLowerCase().replace(/[^a-z0-9]+/g, " ").trim();
      }

      function findDefaultSingleFamilyLabel() {
        const options = [...document.getElementById("fType").options].map((opt) => opt.value);
        const normalized = options.map((value) => ({ value, norm: normalizeForMatch(value) }));
        const exact = normalized.find((x) => x.norm === "single family");
        if (exact) return exact.value;
        const contains = normalized.find((x) => x.norm.includes("single family"));
        if (contains) return contains.value;
        const household = normalized.find((x) => x.norm.includes("household single family"));
        if (household) return household.value;
        return "All";
      }

      function applyDefaultFormFilters() {
        setNeighborhoodSelections([]);
        updateNeighborhoodSummary();
        document.getElementById("fType").value = findDefaultSingleFamilyLabel();
        document.getElementById("fMode").value = "All";
        document.getElementById("fScope").value = "all";
        const minEl = document.getElementById("fMinClose");
        const maxEl = document.getElementById("fMaxClose");
        const minBound = Number(minEl.min || 0);
        const maxBound = Number(maxEl.max || 3000000);
        const minDefault = Math.max(minBound, Math.min(DEFAULT_MIN_CLOSE, maxBound));
        const maxDefault = Math.max(minDefault, Math.min(DEFAULT_MAX_CLOSE, maxBound));
        minEl.value = String(minDefault);
        maxEl.value = String(maxDefault);
        syncPriceSliderPair();
        document.getElementById("fDateFrom").value = "";
        document.getElementById("fDateTo").value = "";
      }

      function normalizeRow(source) {
        const dataMode = inferMode(source);
        const saleDate = source.saleDate || source.pendingDate || source.listDate || "";
        const listDate = source.mlsListDate || source.listDate || "";
        const pendingDate = source.mlsPendingDate || source.pendingDate || "";

        const closePrice = num(source.mlsClosePrice || source.closePrice);
        const assessedValue = num(source.assessedValue);
        const listPriceAtPending = num(source.mlsListPriceAtPending || source.listPriceAtPending || assessedValue || closePrice);

        const daysToPending = daysBetween(listDate, pendingDate);
        const saleToAssessed = assessedValue > 0 ? closePrice / assessedValue : 0;
        const delta = closePrice - listPriceAtPending;
        const deltaPct = listPriceAtPending > 0 ? delta / listPriceAtPending : 0;
        const sqft = num(source.sqft);
        const pricePerSqft = sqft > 0 ? closePrice / sqft : 0;

        return {
          ...source,
          dataMode,
          typeLabel: labelType(source.type, source.typeCode),
          neighborhoodLabel: labelNeighborhood(source.neighborhood, source.zip),
          saleDate: toIso(saleDate),
          listDate: toIso(listDate),
          pendingDate: toIso(pendingDate),
          closePrice,
          assessedValue,
          listPriceAtPending,
          beds: num(source.beds),
          baths: num(source.baths),
          sqft,
          yearBuilt: num(source.yearBuilt),
          daysToPending,
          saleToAssessed,
          delta,
          deltaPct,
          pricePerSqft,
        };
      }

      function getSelectedNeighborhoods() {
        return [...document.querySelectorAll("#fNeighborhoodOptions input[type='checkbox']:checked")]
          .map((cb) => cb.value);
      }

      function setNeighborhoodSelections(values) {
        const selected = new Set(values || []);
        document.querySelectorAll("#fNeighborhoodOptions input[type='checkbox']").forEach((cb) => {
          cb.checked = selected.has(cb.value);
        });
      }

      function updateNeighborhoodSummary() {
        const selected = getSelectedNeighborhoods();
        const summary = document.getElementById("fNeighborhoodSummary");
        if (!selected.length) {
          summary.textContent = "All neighborhoods";
          return;
        }
        if (selected.length === 1) {
          summary.textContent = selected[0];
          return;
        }
        summary.textContent = `${selected.length} neighborhoods selected`;
      }

      function syncPriceSliderPair(changedId) {
        const minEl = document.getElementById("fMinClose");
        const maxEl = document.getElementById("fMaxClose");
        let minVal = Number(minEl.value || PRICE_SLIDER_MIN);
        let maxVal = Number(maxEl.value || PRICE_SLIDER_CAP);
        minVal = Math.max(PRICE_SLIDER_MIN, Math.min(minVal, PRICE_SLIDER_CAP));
        maxVal = Math.max(PRICE_SLIDER_MIN, Math.min(maxVal, PRICE_SLIDER_CAP));
        if (minVal > maxVal) {
          if (changedId === "fMinClose") {
            maxVal = minVal;
          } else {
            minVal = maxVal;
          }
        }
        minEl.value = String(minVal);
        maxEl.value = String(maxVal);
        document.getElementById("fMinCloseValue").textContent = formatMoney(minVal);
        document.getElementById("fMaxCloseValue").textContent = maxVal >= PRICE_SLIDER_CAP
          ? "No max"
          : formatMoney(maxVal);
      }

      function configurePriceSliders() {
        const minEl = document.getElementById("fMinClose");
        const maxEl = document.getElementById("fMaxClose");
        const minCurrent = Number(minEl.value || DEFAULT_MIN_CLOSE);
        const maxCurrent = Number(maxEl.value || DEFAULT_MAX_CLOSE);

        [minEl, maxEl].forEach((el) => {
          el.min = String(PRICE_SLIDER_MIN);
          el.max = String(PRICE_SLIDER_CAP);
          el.step = String(PRICE_SLIDER_STEP);
        });

        const nextMin = Math.max(PRICE_SLIDER_MIN, Math.min(minCurrent, PRICE_SLIDER_CAP));
        const nextMax = Math.max(nextMin, Math.min(maxCurrent, PRICE_SLIDER_CAP));
        minEl.value = String(nextMin);
        maxEl.value = String(nextMax);
        syncPriceSliderPair();
      }

      function uniqueValues(rows, key) {
        return ["All", ...Array.from(new Set(rows.map((r) => r[key]).filter(Boolean))).sort()];
      }

      function refreshSelectOptions() {
        const normalized = state.rows.map(normalizeRow);
        const neighborhoods = Array.from(new Set(normalized.map((r) => r.neighborhoodLabel).filter(Boolean))).sort();
        const types = uniqueValues(normalized, "typeLabel");

        const nWrap = document.getElementById("fNeighborhoodOptions");
        const tSelect = document.getElementById("fType");

        const currentN = new Set(getSelectedNeighborhoods());
        const currentT = tSelect.value || "All";

        nWrap.innerHTML = neighborhoods.length
          ? neighborhoods.map((v) => {
              const checked = currentN.has(v) ? "checked" : "";
              return `<label class="multi-opt"><input type="checkbox" value="${esc(v)}" ${checked} /><span>${esc(v)}</span></label>`;
            }).join("")
          : `<div class="note">No neighborhoods in dataset.</div>`;
        tSelect.innerHTML = types.map((v) => `<option value="${esc(v)}">${esc(v)}</option>`).join("");

        tSelect.value = types.includes(currentT) ? currentT : "All";
        updateNeighborhoodSummary();
        configurePriceSliders();
      }

      function readFormFilters() {
        const maxRaw = Number(document.getElementById("fMaxClose").value || PRICE_SLIDER_CAP);
        return {
          neighborhoods: getSelectedNeighborhoods(),
          type: document.getElementById("fType").value,
          mode: document.getElementById("fMode").value,
          scope: document.getElementById("fScope").value,
          minClose: Number(document.getElementById("fMinClose").value || PRICE_SLIDER_MIN),
          maxClose: maxRaw >= PRICE_SLIDER_CAP ? null : maxRaw,
          dateFrom: document.getElementById("fDateFrom").value,
          dateTo: document.getElementById("fDateTo").value,
        };
      }

      function computeBaseRows() {
        const f = readFormFilters();
        let rows = state.rows.map(normalizeRow).filter((r) => r.closePrice > 0 && !!r.saleDate);

        if (f.neighborhoods.length) rows = rows.filter((r) => f.neighborhoods.includes(r.neighborhoodLabel));
        if (f.type !== "All") rows = rows.filter((r) => r.typeLabel === f.type);
        if (f.mode !== "All") rows = rows.filter((r) => r.dataMode === f.mode);
        if (f.minClose) rows = rows.filter((r) => r.closePrice >= f.minClose);
        if (f.maxClose !== null) rows = rows.filter((r) => r.closePrice <= f.maxClose);
        if (f.dateFrom) rows = rows.filter((r) => r.saleDate >= f.dateFrom);
        if (f.dateTo) rows = rows.filter((r) => r.saleDate <= f.dateTo);

        if (f.scope === "pending7") {
          rows = rows.filter((r) => r.dataMode === "MLS_ENRICHED" && r.daysToPending !== null && r.daysToPending <= 7);
        }

        return rows;
      }

      function computeBaseStats(rows) {
        return {
          medianClose: median(rows.map((r) => r.closePrice)),
          medianPsf: median(rows.filter((r) => r.pricePerSqft > 0).map((r) => r.pricePerSqft)),
        };
      }

      function inRatioBucket(value, key) {
        if (key === "lt095") return value > 0 && value < 0.95;
        if (key === "095to100") return value >= 0.95 && value < 1.0;
        if (key === "100to105") return value >= 1.0 && value <= 1.05;
        if (key === "gt105") return value > 1.05;
        if (key === "gt100") return value > 1.0;
        return true;
      }

      function applyInteractions(baseRows, stats) {
        const i = state.interactions;
        return baseRows.filter((r) => {
          if (i.month && monthKey(r.saleDate) !== i.month) return false;
          if (i.neighborhood && r.neighborhoodLabel !== i.neighborhood) return false;
          if (i.type && r.typeLabel !== i.type) return false;
          if (i.mode && r.dataMode !== i.mode) return false;
          if (i.ratioBucket && !inRatioBucket(r.saleToAssessed, i.ratioBucket)) return false;
          if (i.closeTier === "aboveMedian" && r.closePrice < stats.medianClose) return false;
          if (i.psfTier === "aboveMedian") {
            if (r.pricePerSqft <= 0 || r.pricePerSqft < stats.medianPsf) return false;
          }
          return true;
        });
      }

      function interactionLabel(key, value) {
        const titles = {
          month: "Month",
          neighborhood: "Neighborhood",
          type: "Type",
          ratioBucket: "Ratio",
          mode: "Mode",
          closeTier: "Close Price",
          psfTier: "Price/SqFt",
        };
        const values = {
          lt095: "< 0.95x",
          "095to100": "0.95x - 1.00x",
          "100to105": "1.00x - 1.05x",
          gt105: "> 1.05x",
          gt100: "> 1.00x",
          aboveMedian: "Above Median",
        };
        return `${titles[key] || key}: ${values[value] || value}`;
      }

      function renderChips() {
        const entries = Object.entries(state.interactions).filter(([, v]) => v);
        const el = document.getElementById("activeChips");
        if (!entries.length) {
          el.innerHTML = `<span class="chip">No cross-filters active</span>`;
          return;
        }
        el.innerHTML = entries.map(([k, v]) => {
          return `<span class="chip">${esc(interactionLabel(k, v))}<button type="button" data-clear-interaction="${esc(k)}">x</button></span>`;
        }).join("");
      }

      function renderSummary(filtered, baseRows) {
        const mls = filtered.filter((r) => r.dataMode === "MLS_ENRICHED").length;
        const pub = filtered.length - mls;
        document.getElementById("filterSummary").textContent =
          `Base rows: ${baseRows.length} | Current slice: ${filtered.length} | Public Proxy: ${pub} | MLS Enriched: ${mls}`;
      }

      function renderKpis(rows, stats) {
        const ratios = rows.filter((r) => r.saleToAssessed > 0).map((r) => r.saleToAssessed);
        const psf = rows.filter((r) => r.pricePerSqft > 0).map((r) => r.pricePerSqft);
        const mlsPending = rows.filter((r) => r.dataMode === "MLS_ENRICHED" && r.daysToPending !== null).map((r) => r.daysToPending);

        document.getElementById("kSales").textContent = rows.length;
        document.getElementById("kMedianClose").textContent = formatMoney(median(rows.map((r) => r.closePrice)));
        document.getElementById("kMedianSA").textContent = `${median(ratios).toFixed(2)}x`;
        const above = ratios.length ? (ratios.filter((v) => v > 1).length / ratios.length) * 100 : 0;
        document.getElementById("kAboveAssessed").textContent = `${above.toFixed(1)}%`;
        document.getElementById("kPsf").textContent = formatMoney(median(psf));
        document.getElementById("kPendingDays").textContent = mlsPending.length ? `${median(mlsPending).toFixed(0)} days` : "n/a";

        document.querySelectorAll(".kbtn").forEach((b) => b.classList.remove("active"));
        if (state.interactions.closeTier === "aboveMedian") document.querySelector('[data-kpi-action="closeTier"]').classList.add("active");
        if (state.interactions.ratioBucket === "100to105") document.querySelector('[data-kpi-action="ratioMid"]').classList.add("active");
        if (state.interactions.ratioBucket === "gt100") document.querySelector('[data-kpi-action="ratioGt1"]').classList.add("active");
        if (state.interactions.psfTier === "aboveMedian") document.querySelector('[data-kpi-action="psfTier"]').classList.add("active");
        if (state.interactions.mode === "MLS_ENRICHED") document.querySelector('[data-kpi-action="mlsOnly"]').classList.add("active");
      }

      function renderInsights(rows) {
        const el = document.getElementById("insights");
        if (!rows.length) {
          el.innerHTML = `<li>No rows match current filters. Widen criteria or clear cross-filters.</li>`;
          return;
        }

        const ratios = rows.filter((r) => r.saleToAssessed > 0).map((r) => r.saleToAssessed);
        const overShare = ratios.length ? (ratios.filter((v) => v > 1).length / ratios.length) * 100 : 0;

        const byNeighborhood = {};
        rows.forEach((r) => { byNeighborhood[r.neighborhoodLabel] = (byNeighborhood[r.neighborhoodLabel] || 0) + 1; });
        const topNeighborhood = Object.entries(byNeighborhood).sort((a, b) => b[1] - a[1])[0];

        const byMonth = {};
        rows.forEach((r) => {
          const m = monthKey(r.saleDate);
          byMonth[m] = (byMonth[m] || 0) + 1;
        });
        const topMonth = Object.entries(byMonth).sort((a, b) => b[1] - a[1])[0];

        const lines = [
          `Median close price is ${formatMoney(median(rows.map((r) => r.closePrice)))} across ${rows.length} homes in this slice.`,
          `${overShare.toFixed(1)}% of homes closed above assessed value (median S/A ${median(ratios).toFixed(2)}x).`,
          `Highest activity is ${topNeighborhood ? topNeighborhood[0] : "n/a"} (${topNeighborhood ? topNeighborhood[1] : 0} sales).`,
          `Most active month is ${topMonth ? monthLabel(topMonth[0]) : "n/a"} (${topMonth ? topMonth[1] : 0} sales).`,
        ];

        const mlsRows = rows.filter((r) => r.dataMode === "MLS_ENRICHED" && r.daysToPending !== null);
        if (mlsRows.length) {
          lines.push(`MLS-enriched subset median days-to-pending: ${median(mlsRows.map((r) => r.daysToPending)).toFixed(0)} days.`);
        } else {
          lines.push("This slice currently uses public-record timing only. MLS timeline fields can be layered in when available.");
        }

        lines.push("Color scales cap outlier influence at robust percentile bounds (5th-95th).\n");
        el.innerHTML = lines.map((line) => `<li>${esc(line)}</li>`).join("");
      }

      function renderColumnChart(containerId, items, valueFn, labelFn, tailFn, warm) {
        const container = document.getElementById(containerId);
        if (!items.length) {
          container.innerHTML = `<div class="note">No rows for current filters.</div>`;
          return;
        }

        const vals = items.map((i) => valueFn(i));
        const qLow = quantile(vals, 0.05);
        const qHigh = quantile(vals, 0.95);
        const minVal = Math.min(...vals);
        const maxVal = Math.max(...vals);
        const low = Number.isFinite(qLow) ? qLow : minVal;
        const high = Number.isFinite(qHigh) ? qHigh : maxVal;
        const span = Math.max(high - low, 1);

        const topLabel = tailFn({ v: high, raw: maxVal, kind: "top" });
        const midLabel = tailFn({ v: low + span / 2, raw: (minVal + maxVal) / 2, kind: "mid" });
        const lowLabel = tailFn({ v: low, raw: minVal, kind: "low" });

        const bars = items.map((item) => {
          const raw = valueFn(item);
          const clamped = Math.max(low, Math.min(high, raw));
          const norm = (clamped - low) / span;
          const height = 12 + (norm * 88);
          const active = state.interactions.month === item.month;
          return `
            <button class="vbar ${active ? "active" : ""}" data-set-interaction="month" data-set-value="${esc(item.month)}" type="button">
              <span class="vbar-track"><span class="vbar-fill ${warm ? "warm" : ""}" style="height:${height}%"></span></span>
              <span class="vbar-month">${esc(labelFn(item))}</span>
              <span class="vbar-value">${esc(tailFn({ v: raw, raw, kind: "point" }))}</span>
            </button>
          `;
        }).join("");

        container.innerHTML = `
          <div class="vchart">
            <div class="y-axis">
              <span>${esc(topLabel)}</span>
              <span>${esc(midLabel)}</span>
              <span>${esc(lowLabel)}</span>
            </div>
            <div class="plot">${bars}</div>
          </div>
        `;
      }

      function renderCharts(rows) {
        const volume = {};
        rows.forEach((r) => {
          const m = monthKey(r.saleDate);
          if (!volume[m]) volume[m] = { month: m, count: 0 };
          volume[m].count += 1;
        });
        const volumeRows = Object.values(volume).sort((a, b) => a.month.localeCompare(b.month));
        renderColumnChart(
          "chartVolume",
          volumeRows,
          (x) => x.count,
          (x) => monthLabel(x.month),
          (x) => `${Math.round(x.v).toLocaleString("en-US")} sales`,
          false
        );

        const price = {};
        rows.forEach((r) => {
          const m = monthKey(r.saleDate);
          if (!price[m]) price[m] = [];
          price[m].push(r.closePrice);
        });
        const priceRows = Object.entries(price)
          .map(([month, vals]) => ({ month, medianPrice: median(vals) }))
          .sort((a, b) => a.month.localeCompare(b.month));
        renderColumnChart(
          "chartMedian",
          priceRows,
          (x) => x.medianPrice,
          (x) => monthLabel(x.month),
          (x) => formatMoney(x.v),
          true
        );
      }

      function renderRatioRows(rows) {
        const tbody = document.getElementById("ratioRows");
        if (!rows.length) {
          tbody.innerHTML = `<tr><td colspan="4">No rows for current filters.</td></tr>`;
          return;
        }

        const buckets = [
          { key: "lt095", label: "< 0.95x" },
          { key: "095to100", label: "0.95x - 1.00x" },
          { key: "100to105", label: "1.00x - 1.05x" },
          { key: "gt105", label: "> 1.05x" },
        ];

        const total = rows.length;
        tbody.innerHTML = buckets.map((b) => {
          const set = rows.filter((r) => inRatioBucket(r.saleToAssessed, b.key));
          const share = total ? ((set.length / total) * 100).toFixed(1) : "0.0";
          const active = state.interactions.ratioBucket === b.key;
          return `
            <tr class="clickable ${active ? "active" : ""}" data-set-interaction="ratioBucket" data-set-value="${esc(b.key)}">
              <td>${esc(b.label)}</td>
              <td>${set.length}</td>
              <td>${share}%</td>
              <td>${formatMoney(median(set.map((r) => r.closePrice)))}</td>
            </tr>
          `;
        }).join("");
      }

      function renderRankRows(rows) {
        const tbody = document.getElementById("rankRows");
        if (!rows.length) {
          tbody.innerHTML = `<tr><td colspan="4">No rows for current filters.</td></tr>`;
          return;
        }

        const grouped = {};
        rows.forEach((r) => {
          if (!grouped[r.neighborhoodLabel]) grouped[r.neighborhoodLabel] = [];
          grouped[r.neighborhoodLabel].push(r);
        });

        const rank = Object.entries(grouped)
          .map(([name, set]) => ({
            name,
            count: set.length,
            medianClose: median(set.map((r) => r.closePrice)),
            medianRatio: median(set.filter((r) => r.saleToAssessed > 0).map((r) => r.saleToAssessed)),
          }))
          .sort((a, b) => (b.count - a.count) || (b.medianClose - a.medianClose))
          .slice(0, 18);

        tbody.innerHTML = rank.map((r) => {
          const active = state.interactions.neighborhood === r.name;
          return `
            <tr class="clickable ${active ? "active" : ""}" data-set-interaction="neighborhood" data-set-value="${esc(r.name)}">
              <td>${esc(r.name)}</td>
              <td>${r.count}</td>
              <td>${formatMoney(r.medianClose)}</td>
              <td>${r.medianRatio.toFixed(2)}x</td>
            </tr>
          `;
        }).join("");
      }

      function seqScale(values) {
        if (!values.length) return () => 0;
        const low = quantile(values, 0.05);
        const high = quantile(values, 0.95);
        const span = Math.max(high - low, 1);
        return (v) => {
          const clamped = Math.max(low, Math.min(high, v));
          return (clamped - low) / span;
        };
      }

      function divScale(values) {
        const abs = values.map((v) => Math.abs(v)).filter((v) => v > 0);
        if (!abs.length) return () => 0;
        const cap = Math.max(quantile(abs, 0.95), 1);
        return (v) => Math.max(-1, Math.min(1, v / cap));
      }

      function seqHeat(norm, color) {
        const pct = Math.round(Math.max(0, Math.min(1, norm)) * 100);
        return `background: linear-gradient(90deg, ${color} ${pct}%, rgba(255,255,255,0.03) ${pct}%);`;
      }

      function divHeat(norm) {
        const pct = Math.round(Math.max(0, Math.min(1, Math.abs(norm))) * 100);
        const color = norm >= 0 ? "rgba(61, 213, 157, 0.34)" : "rgba(230, 113, 140, 0.34)";
        return `background: linear-gradient(90deg, ${color} ${pct}%, rgba(255,255,255,0.03) ${pct}%);`;
      }

      function zillowUrl(row) {
        const q = encodeURIComponent(`${row.address} Seattle WA ${row.zip || ""}`.trim());
        return `https://www.zillow.com/homes/${q}_rb/`;
      }

      function getRecordSortValue(row, key) {
        if (key === "address") return String(row.address || "");
        if (key === "neighborhood") return String(row.neighborhoodLabel || "");
        if (key === "type") return String(row.typeLabel || "");
        if (key === "beds") return Number(row.beds || 0);
        if (key === "baths") return Number(row.baths || 0);
        if (key === "sqft") return Number(row.sqft || 0);
        if (key === "saleDate") return String(row.saleDate || "");
        if (key === "closePrice") return Number(row.closePrice || 0);
        if (key === "assessedValue") return Number(row.assessedValue || 0);
        if (key === "saleToAssessed") return Number(row.saleToAssessed || 0);
        if (key === "delta") return Number(row.delta || 0);
        if (key === "dataMode") return String(row.dataMode || "");
        return "";
      }

      function applyRecordSort(rows) {
        const { key, dir } = state.recordSort;
        const factor = dir === "asc" ? 1 : -1;
        return rows.slice().sort((a, b) => {
          const av = getRecordSortValue(a, key);
          const bv = getRecordSortValue(b, key);
          if (typeof av === "number" && typeof bv === "number") return (av - bv) * factor;
          return String(av).localeCompare(String(bv), undefined, { numeric: true, sensitivity: "base" }) * factor;
        });
      }

      function updateRecordSortHeaderUI() {
        document.querySelectorAll(".th-sort").forEach((btn) => {
          btn.classList.remove("active");
        });
        document.querySelectorAll("[data-sort-ind]").forEach((el) => {
          el.textContent = "";
        });
        const active = document.querySelector(`.th-sort[data-record-sort="${state.recordSort.key}"]`);
        if (active) active.classList.add("active");
        const ind = document.querySelector(`[data-sort-ind="${state.recordSort.key}"]`);
        if (ind) ind.textContent = state.recordSort.dir === "asc" ? "" : "";
      }

      function setRecordSort(key) {
        const textKeys = new Set(["address", "neighborhood", "type", "dataMode"]);
        if (state.recordSort.key === key) {
          state.recordSort.dir = state.recordSort.dir === "asc" ? "desc" : "asc";
        } else {
          state.recordSort.key = key;
          state.recordSort.dir = textKeys.has(key) ? "asc" : "desc";
        }
        renderAll();
      }

      function renderRecordRows(rows) {
        const tbody = document.getElementById("recordRows");
        if (!rows.length) {
          tbody.innerHTML = `<tr><td colspan="12">No rows for current filters.</td></tr>`;
          updateRecordSortHeaderUI();
          return;
        }

        const ratioNorm = seqScale(rows.filter((r) => r.saleToAssessed > 0).map((r) => r.saleToAssessed));
        const deltaNorm = divScale(rows.map((r) => r.delta));
        const sortedRows = applyRecordSort(rows);

        tbody.innerHTML = sortedRows
          .map((r) => {
            const nActive = state.interactions.neighborhood === r.neighborhoodLabel;
            const tActive = state.interactions.type === r.typeLabel;
            return `
              <tr>
                <td><a class="address-link" href="${esc(zillowUrl(r))}" target="_blank" rel="noopener noreferrer">${esc(r.address)}<span class="ext-icon" aria-hidden="true">&#8599;</span></a></td>
                <td><button class="mini-btn ${nActive ? "active" : ""}" data-set-interaction="neighborhood" data-set-value="${esc(r.neighborhoodLabel)}">${esc(r.neighborhoodLabel)}</button></td>
                <td><button class="mini-btn ${tActive ? "active" : ""}" data-set-interaction="type" data-set-value="${esc(r.typeLabel)}">${esc(r.typeLabel)}</button></td>
                <td>${r.beds || 0}</td>
                <td>${r.baths ? r.baths.toFixed(2) : "0.00"}</td>
                <td>${r.sqft ? r.sqft.toLocaleString("en-US") : "0"}</td>
                <td>${esc(r.saleDate || "n/a")}</td>
                <td>${formatMoney(r.closePrice)}</td>
                <td>${formatMoney(r.assessedValue)}</td>
                <td><span class="heat" style="${seqHeat(r.saleToAssessed > 0 ? ratioNorm(r.saleToAssessed) : 0, "rgba(61,213,157,0.33)")}">${r.saleToAssessed > 0 ? `${r.saleToAssessed.toFixed(2)}x` : "n/a"}</span></td>
                <td><span class="heat" style="${divHeat(deltaNorm(r.delta))}">${formatMoney(r.delta)}</span></td>
                <td><span class="mode">${esc(r.dataMode)}</span></td>
              </tr>
            `;
          })
          .join("");
        updateRecordSortHeaderUI();
      }

      function renderAll() {
        const baseRows = computeBaseRows();
        state.baseRows = baseRows;
        const stats = computeBaseStats(baseRows);
        const filtered = applyInteractions(baseRows, stats);
        state.filteredRows = filtered;

        renderSummary(filtered, baseRows);
        renderChips();
        renderKpis(filtered, stats);
        renderInsights(filtered);
        renderCharts(filtered);
        renderRatioRows(filtered);
        renderRankRows(filtered);
        renderRecordRows(filtered);
      }

      function setInteraction(key, value) {
        state.interactions[key] = state.interactions[key] === value ? null : value;
        renderAll();
      }

      function clearCrossFilters() {
        Object.keys(state.interactions).forEach((k) => { state.interactions[k] = null; });
        renderAll();
      }

      function resetFormFilters() {
        applyDefaultFormFilters();
      }

      function escapeCsv(v) {
        const s = String(v ?? "");
        if (s.includes(",") || s.includes('"') || s.includes("\n")) return `"${s.replace(/"/g, '""')}"`;
        return s;
      }

      function exportFilteredCsv() {
        if (!state.filteredRows.length) return;
        const headers = [
          "id","address","neighborhood","type","dataMode","saleDate","listDate","pendingDate",
          "closePrice","assessedValue","saleToAssessed","listPriceAtPending","delta","deltaPct",
          "beds","baths","sqft","yearBuilt","zip"
        ];
        const lines = [headers.join(",")];
        state.filteredRows.forEach((r) => {
          lines.push([
            r.id,
            r.address,
            r.neighborhoodLabel,
            r.typeLabel,
            r.dataMode,
            r.saleDate,
            r.listDate,
            r.pendingDate,
            r.closePrice,
            r.assessedValue,
            r.saleToAssessed,
            r.listPriceAtPending,
            r.delta,
            r.deltaPct,
            r.beds,
            r.baths,
            r.sqft,
            r.yearBuilt,
            r.zip,
          ].map(escapeCsv).join(","));
        });

        const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "seattle_buyer_lens_filtered.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function applyTheme(theme) {
        const body = document.body;
        body.classList.remove("light", "dark");
        body.classList.add(theme);
        const toggle = document.getElementById("themeToggle");
        if (toggle) {
          toggle.textContent = theme === "light" ? "Switch To Dark Mode" : "Switch To Light Mode";
        }
        try {
          localStorage.setItem("buyer_lens_theme", theme);
        } catch (err) {
          // ignore storage errors
        }
      }

      function initTheme() {
        let saved = "light";
        try {
          saved = localStorage.getItem("buyer_lens_theme") || "light";
        } catch (err) {
          saved = "light";
        }
        applyTheme(saved === "dark" ? "dark" : "light");
      }

      function bindEvents() {
        ["fType", "fMode", "fScope", "fDateFrom", "fDateTo"].forEach((id) => {
          const el = document.getElementById(id);
          el.addEventListener("input", renderAll);
          el.addEventListener("change", renderAll);
        });
        ["fMinClose", "fMaxClose"].forEach((id) => {
          const el = document.getElementById(id);
          el.addEventListener("input", () => {
            syncPriceSliderPair(id);
            renderAll();
          });
          el.addEventListener("change", () => {
            syncPriceSliderPair(id);
            renderAll();
          });
        });

        const nOptions = document.getElementById("fNeighborhoodOptions");
        nOptions.addEventListener("change", (evt) => {
          if (!evt.target.matches("input[type='checkbox']")) return;
          updateNeighborhoodSummary();
          renderAll();
        });
        document.getElementById("fNeighborhoodSelectAll").addEventListener("click", () => {
          const all = [...document.querySelectorAll("#fNeighborhoodOptions input[type='checkbox']")].map((cb) => cb.value);
          setNeighborhoodSelections(all);
          updateNeighborhoodSummary();
          renderAll();
        });
        document.getElementById("fNeighborhoodClear").addEventListener("click", () => {
          setNeighborhoodSelections([]);
          updateNeighborhoodSummary();
          renderAll();
        });

        document.getElementById("resetBtn").addEventListener("click", () => {
          resetFormFilters();
          clearCrossFilters();
        });
        document.getElementById("clearCrossBtn").addEventListener("click", clearCrossFilters);
        document.getElementById("exportCsvBtn").addEventListener("click", exportFilteredCsv);
        document.getElementById("themeToggle").addEventListener("click", () => {
          const next = document.body.classList.contains("light") ? "dark" : "light";
          applyTheme(next);
        });
        document.getElementById("globalFilters").addEventListener("toggle", () => {
          const dd = document.getElementById("fNeighborhood");
          if (!document.getElementById("globalFilters").open) dd.removeAttribute("open");
        });

        document.querySelectorAll(".tab").forEach((btn) => {
          btn.addEventListener("click", () => {
            document.querySelectorAll(".tab").forEach((x) => x.classList.remove("active"));
            btn.classList.add("active");
            const target = btn.getAttribute("data-view");
            document.querySelectorAll(".view").forEach((v) => v.classList.toggle("active", v.id === `view-${target}`));
          });
        });

        document.addEventListener("click", (evt) => {
          const sortBtn = evt.target.closest("[data-record-sort]");
          if (sortBtn) {
            setRecordSort(sortBtn.getAttribute("data-record-sort"));
            return;
          }

          const set = evt.target.closest("[data-set-interaction]");
          if (set) {
            setInteraction(set.getAttribute("data-set-interaction"), set.getAttribute("data-set-value"));
            return;
          }

          const clear = evt.target.closest("[data-clear-interaction]");
          if (clear) {
            const key = clear.getAttribute("data-clear-interaction");
            state.interactions[key] = null;
            renderAll();
            return;
          }

          const kpi = evt.target.closest("[data-kpi-action]");
          if (!kpi) return;
          const action = kpi.getAttribute("data-kpi-action");
          if (action === "clear") return clearCrossFilters();
          if (action === "closeTier") return setInteraction("closeTier", "aboveMedian");
          if (action === "ratioMid") return setInteraction("ratioBucket", "100to105");
          if (action === "ratioGt1") return setInteraction("ratioBucket", "gt100");
          if (action === "psfTier") return setInteraction("psfTier", "aboveMedian");
          if (action === "mlsOnly") return setInteraction("mode", "MLS_ENRICHED");
        });

        const csvInput = document.getElementById("csvFile");
        if (csvInput) {
          csvInput.addEventListener("change", (evt) => {
            const file = evt.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
              try {
                state.rows = parseCsv(reader.result);
                refreshSelectOptions();
                applyDefaultFormFilters();
                clearCrossFilters();
                document.getElementById("uploadStatus").textContent = `Loaded ${state.rows.length} rows from ${file.name}.`;
                document.getElementById("datasetStatus").textContent = `Using uploaded dataset: ${file.name} (${state.rows.length} rows).`;
              } catch (err) {
                document.getElementById("uploadStatus").textContent = `Upload failed: ${err.message}`;
              }
            };
            reader.readAsText(file);
          });
        }
      }

      async function autoLoadDefault() {
        const status = document.getElementById("datasetStatus");
        try {
          const response = await fetch(DEFAULT_DATASET, { cache: "no-store" });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const text = await response.text();
          state.rows = parseCsv(text);
          refreshSelectOptions();
          applyDefaultFormFilters();
          clearCrossFilters();
          document.getElementById("uploadStatus").textContent = `Auto-loaded ${DEFAULT_DATASET}.`;
          status.textContent = `Auto-loaded ${DEFAULT_DATASET} (${state.rows.length} rows).`;
        } catch (err) {
          state.rows = [];
          refreshSelectOptions();
          renderAll();
          status.textContent = "Auto-load unavailable. Serve over HTTP (scripts/serve.js) so the default dataset can load.";
        }
      }

      function init() {
        initTheme();
        bindEvents();
        autoLoadDefault();
      }

      init();
    </script>
  </body>
</html>
