<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Seattle Housing Buyer Lens</title>
    <style>
      :root {
        --bg: #0a1220;
        --bg-elev: #111c2f;
        --bg-elev-2: #16243b;
        --line: #2a3e5f;
        --text: #ecf3ff;
        --muted: #9fb4d4;
        --primary: #4da6ff;
        --primary-2: #3dd59d;
        --warn: #e6b35a;
        --danger: #e6718c;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        background:
          radial-gradient(1100px 600px at -15% -25%, #17335f 0%, transparent 55%),
          radial-gradient(1000px 600px at 115% -15%, #4a1f59 0%, transparent 52%),
          var(--bg);
        color: var(--text);
        font-family: "Iowan Old Style", "Palatino Linotype", Palatino, serif;
      }
      a { color: #95d0ff; text-decoration: none; }
      a:hover { text-decoration: underline; }

      header {
        max-width: 1260px;
        margin: 0 auto;
        padding: 28px 22px 10px;
      }
      h1 {
        margin: 0;
        font-size: 34px;
        letter-spacing: 0.4px;
      }
      .subtitle {
        margin-top: 8px;
        color: var(--muted);
        font-size: 14px;
      }
      .status {
        margin-top: 8px;
        color: var(--muted);
        font-size: 12px;
      }

      .tabs {
        margin-top: 14px;
        display: inline-flex;
        border: 1px solid var(--line);
        border-radius: 999px;
        overflow: hidden;
        background: rgba(17, 28, 47, 0.88);
      }
      .tab {
        border: none;
        background: transparent;
        color: var(--muted);
        font-size: 13px;
        padding: 9px 14px;
        cursor: pointer;
      }
      .tab.active {
        color: #fff;
        background: linear-gradient(135deg, #275ea7, #2d8cb4);
      }

      .app {
        max-width: 1260px;
        margin: 0 auto;
        padding: 14px 22px 30px;
        display: grid;
        gap: 14px;
      }
      .panel {
        background: linear-gradient(180deg, rgba(17,28,47,0.96), rgba(13,22,36,0.95));
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 14px;
        box-shadow: 0 12px 28px rgba(0,0,0,0.34);
      }
      .panel h3 {
        margin: 0 0 10px;
        font-size: 18px;
      }

      .filters {
        display: grid;
        grid-template-columns: repeat(8, minmax(0, 1fr));
        gap: 10px;
      }
      .field label {
        display: block;
        margin-bottom: 4px;
        color: var(--muted);
        font-size: 12px;
      }
      select, input {
        width: 100%;
        color: var(--text);
        background: #0c1728;
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 8px 10px;
        font-size: 14px;
      }
      .actions {
        display: flex;
        align-items: flex-end;
        gap: 8px;
      }
      .btn {
        border: 1px solid #2f76c4;
        border-radius: 10px;
        padding: 9px 12px;
        font-size: 13px;
        color: #fff;
        background: linear-gradient(135deg, #21589d, #2b93ba);
        cursor: pointer;
      }
      .btn.alt {
        border-color: var(--line);
        background: #0c1728;
        color: #d3e5ff;
      }
      .summary {
        margin-top: 8px;
        color: var(--muted);
        font-size: 12px;
      }
      .chips {
        margin-top: 8px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid #35547a;
        background: #15253d;
        color: #d8e8ff;
        font-size: 12px;
      }
      .chip button {
        border: none;
        background: transparent;
        color: #9ec0e8;
        cursor: pointer;
      }

      .view { display: none; }
      .view.active { display: grid; gap: 14px; }

      .guide {
        margin: 0;
        padding-left: 18px;
        color: #dce9ff;
        display: grid;
        gap: 7px;
      }
      .insights {
        margin: 0;
        padding-left: 18px;
        display: grid;
        gap: 7px;
      }

      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(6, minmax(0, 1fr));
        gap: 10px;
      }
      .kpi {
        border: 1px solid var(--line);
        border-radius: 12px;
        background: linear-gradient(180deg, #122440, #0f1d33);
        padding: 10px;
        display: grid;
        gap: 6px;
      }
      .kpi .label {
        color: var(--muted);
        font-size: 12px;
      }
      .kpi .value {
        font-size: 22px;
      }
      .kpi .kbtn {
        justify-self: start;
        border: 1px solid #37567a;
        border-radius: 999px;
        padding: 3px 8px;
        font-size: 11px;
        color: #dcecff;
        background: #12233a;
        cursor: pointer;
      }
      .kpi .kbtn.active {
        border-color: #4eb2ff;
      }

      .two-col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }
      .chart {
        display: grid;
        gap: 8px;
      }
      .bar-row {
        width: 100%;
        border: 1px solid #2d4363;
        border-radius: 10px;
        background: #0f1b2f;
        color: #dce8ff;
        cursor: pointer;
        padding: 6px;
        display: grid;
        grid-template-columns: 110px 1fr 150px;
        gap: 8px;
        align-items: center;
        font-size: 13px;
      }
      .bar-row.active {
        border-color: #4eb2ff;
      }
      .track {
        width: 100%;
        height: 11px;
        border-radius: 999px;
        background: #1f2f49;
        overflow: hidden;
      }
      .fill {
        height: 100%;
        background: linear-gradient(90deg, #3d93ed, #56d1ff);
      }
      .fill.warm {
        background: linear-gradient(90deg, #cc8536, #f3c366);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th, td {
        text-align: left;
        padding: 8px 6px;
        border-bottom: 1px solid rgba(42,62,95,0.78);
      }
      th {
        color: var(--muted);
        font-weight: 600;
      }
      tr.clickable { cursor: pointer; }
      tr.clickable:hover { background: rgba(56,92,147,0.16); }
      tr.clickable.active { background: rgba(78,178,255,0.17); }

      .mini-btn {
        border: 1px solid #35547a;
        border-radius: 999px;
        background: #12233a;
        color: #dcecff;
        font-size: 11px;
        padding: 2px 8px;
        cursor: pointer;
      }
      .mini-btn.active {
        border-color: #4eb2ff;
      }
      .mode {
        display: inline-block;
        border: 1px solid #35547a;
        border-radius: 999px;
        background: #15253d;
        color: #dcecff;
        font-size: 11px;
        padding: 2px 8px;
      }
      .heat {
        display: inline-block;
        min-width: 92px;
        border-radius: 8px;
        padding: 3px 6px;
      }

      .mono {
        font-family: "SFMono-Regular", Menlo, Consolas, monospace;
        font-size: 12px;
        background: #0b1526;
        border: 1px solid var(--line);
        border-radius: 10px;
        white-space: pre-wrap;
        padding: 10px;
      }
      .note {
        margin-top: 8px;
        color: var(--muted);
        font-size: 12px;
      }

      @media (max-width: 1120px) {
        .filters { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        .kpi-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .two-col { grid-template-columns: 1fr; }
      }
      @media (max-width: 680px) {
        .filters { grid-template-columns: 1fr 1fr; }
        .kpi-grid { grid-template-columns: 1fr 1fr; }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Seattle Housing Buyer Lens</h1>
      <div class="subtitle">Buyer-focused market view for Seattle. Public-record sales now, MLS-enriched fields later. Every chart and metric can filter the entire dashboard.</div>
      <div class="tabs" role="tablist">
        <button class="tab active" data-view="overview" role="tab">Overview</button>
        <button class="tab" data-view="charts" role="tab">Charts</button>
        <button class="tab" data-view="records" role="tab">Records</button>
        <button class="tab" data-view="data" role="tab">Data</button>
      </div>
      <div class="status" id="datasetStatus">Initializing dataset...</div>
    </header>

    <main class="app">
      <section class="panel">
        <h3>Global Filters</h3>
        <div class="filters">
          <div class="field">
            <label for="fNeighborhood">Neighborhood</label>
            <select id="fNeighborhood"></select>
          </div>
          <div class="field">
            <label for="fType">Property Type</label>
            <select id="fType"></select>
          </div>
          <div class="field">
            <label for="fMode">Data Mode</label>
            <select id="fMode">
              <option value="All">All</option>
              <option value="PUBLIC_PROXY">Public Proxy</option>
              <option value="MLS_ENRICHED">MLS Enriched</option>
            </select>
          </div>
          <div class="field">
            <label for="fScope">Scope</label>
            <select id="fScope">
              <option value="all">All Sales</option>
              <option value="pending7">MLS Pending <= 7 Days</option>
            </select>
          </div>
          <div class="field">
            <label for="fMinClose">Min Close Price</label>
            <input id="fMinClose" type="number" placeholder="1100000" />
          </div>
          <div class="field">
            <label for="fMaxClose">Max Close Price</label>
            <input id="fMaxClose" type="number" placeholder="1400000" />
          </div>
          <div class="field">
            <label for="fDateFrom">Sale Date From</label>
            <input id="fDateFrom" type="date" />
          </div>
          <div class="field">
            <label for="fDateTo">Sale Date To</label>
            <input id="fDateTo" type="date" />
          </div>
          <div class="actions">
            <button class="btn" id="exportCsvBtn" type="button">Export Filtered CSV</button>
            <button class="btn alt" id="resetBtn" type="button">Reset</button>
            <button class="btn alt" id="clearCrossBtn" type="button">Clear Cross-Filters</button>
          </div>
        </div>
        <div class="summary" id="filterSummary">No data loaded.</div>
        <div class="chips" id="activeChips"></div>
      </section>

      <section id="view-overview" class="view active">
        <section class="panel">
          <h3>How To Use This Dashboard</h3>
          <ul class="guide">
            <li>Start with price/date filters to define your buy box, then click chart rows or table rows to drill down.</li>
            <li>Every interactive metric and chart item applies a cross-filter across all tabs.</li>
            <li>Use the chips row to remove individual cross-filters, or click Clear Cross-Filters.</li>
            <li>Public Proxy mode has real close prices and assessed values, but not true original list/pending timestamps.</li>
            <li>MLS Enriched mode supports true list/pending/close fields when your realtor provides them.</li>
          </ul>
        </section>

        <div class="kpi-grid">
          <article class="kpi">
            <div class="label">Sales Count</div>
            <div class="value" id="kSales">0</div>
            <button class="kbtn" data-kpi-action="clear">Clear Cross-Filters</button>
          </article>
          <article class="kpi">
            <div class="label">Median Close Price</div>
            <div class="value" id="kMedianClose">$0</div>
            <button class="kbtn" data-kpi-action="closeTier">Filter Close >= Median</button>
          </article>
          <article class="kpi">
            <div class="label">Median Sale / Assessed</div>
            <div class="value" id="kMedianSA">0.00x</div>
            <button class="kbtn" data-kpi-action="ratioMid">Filter 1.00x - 1.05x</button>
          </article>
          <article class="kpi">
            <div class="label">Share Above Assessed</div>
            <div class="value" id="kAboveAssessed">0%</div>
            <button class="kbtn" data-kpi-action="ratioGt1">Filter S/A > 1.00x</button>
          </article>
          <article class="kpi">
            <div class="label">Median Price / SqFt</div>
            <div class="value" id="kPsf">$0</div>
            <button class="kbtn" data-kpi-action="psfTier">Filter $/SqFt >= Median</button>
          </article>
          <article class="kpi">
            <div class="label">Median Days To Pending (MLS)</div>
            <div class="value" id="kPendingDays">n/a</div>
            <button class="kbtn" data-kpi-action="mlsOnly">Filter MLS Rows</button>
          </article>
        </div>

        <section class="panel">
          <h3>Current Slice Readout</h3>
          <ul class="insights" id="insights"></ul>
        </section>
      </section>

      <section id="view-charts" class="view">
        <div class="two-col">
          <section class="panel">
            <h3>Monthly Sales Volume</h3>
            <div class="chart" id="chartVolume"></div>
          </section>
          <section class="panel">
            <h3>Monthly Median Close Price</h3>
            <div class="chart" id="chartMedian"></div>
          </section>
        </div>
        <div class="two-col">
          <section class="panel">
            <h3>Sale / Assessed Buckets</h3>
            <table>
              <thead>
                <tr><th>Bucket</th><th>Count</th><th>Share</th><th>Median Close</th></tr>
              </thead>
              <tbody id="ratioRows"></tbody>
            </table>
          </section>
          <section class="panel">
            <h3>Neighborhood Leaderboard</h3>
            <table>
              <thead>
                <tr><th>Neighborhood</th><th>Count</th><th>Median Close</th><th>Median S/A</th></tr>
              </thead>
              <tbody id="rankRows"></tbody>
            </table>
          </section>
        </div>
      </section>

      <section id="view-records" class="view">
        <section class="panel">
          <h3>Row-Level Summary</h3>
          <table>
            <thead>
              <tr>
                <th>Address</th>
                <th>Neighborhood</th>
                <th>Type</th>
                <th>Beds</th>
                <th>Baths</th>
                <th>SqFt</th>
                <th>Sale Date</th>
                <th>Close Price</th>
                <th>Assessed</th>
                <th>S/A</th>
                <th>Delta vs List@Pending</th>
                <th>Data Mode</th>
              </tr>
            </thead>
            <tbody id="recordRows"></tbody>
          </table>
          <div class="note">Address links open Zillow search results. Heat gradients cap outliers using robust percentiles.</div>
        </section>
      </section>

      <section id="view-data" class="view">
        <section class="panel">
          <h3>Data Source and Upload</h3>
          <div class="note" id="uploadStatus">No file loaded.</div>
          <input id="csvFile" type="file" accept=".csv" />

          <p class="note">Auto-load filename:</p>
          <div class="mono">public_sales_proxy_1p1m_1p4m_last6mo.csv</div>

          <p class="note">Minimum columns:</p>
          <div class="mono">id,address,type,closePrice</div>

          <p class="note">Recommended columns:</p>
          <div class="mono">dataMode,neighborhood,typeCode,zip,listDate,pendingDate,saleDate,listPriceAtPending,assessedValue,beds,baths,sqft,yearBuilt,mlsListDate,mlsPendingDate,mlsListPriceAtPending,mlsClosePrice</div>

          <p class="note">Intended use:</p>
          <div class="mono">Buyer-side neighborhood and pricing-pressure analysis for Seattle. PUBLIC_PROXY mode does not contain true original listing timeline fields.</div>
        </section>
      </section>
    </main>

    <script>
      const DEFAULT_DATASET = "public_sales_proxy_1p1m_1p4m_last6mo.csv";

      const TYPE_LABELS = {
        "11": "Single-family house",
        "12": "Residential multi-family (2-4 units)",
        "13": "Residential multi-family (5+ units)",
        "14": "Residential condominium",
        "15": "Mobile home park/court",
        "18": "Other residential",
        "19": "Vacation/cabin",
        "50": "Commercial or non-residential condo",
        "91": "Undeveloped land",
      };

      const ZIP_NEIGHBORHOOD = {
        "98101": "Downtown",
        "98102": "Capitol Hill / Eastlake",
        "98103": "Fremont / Green Lake / Wallingford",
        "98104": "Pioneer Square / International District",
        "98105": "University District / Laurelhurst",
        "98106": "Delridge / South Park",
        "98107": "Ballard",
        "98108": "Georgetown / South Park",
        "98109": "South Lake Union / Queen Anne",
        "98111": "Downtown",
        "98112": "Capitol Hill / Madison Park",
        "98115": "Ravenna / Wedgwood",
        "98116": "West Seattle",
        "98117": "Ballard / Crown Hill",
        "98118": "Columbia City / Rainier Valley",
        "98119": "Queen Anne / Magnolia",
        "98121": "Belltown",
        "98122": "Capitol Hill / Central District",
        "98124": "Downtown",
        "98125": "Lake City / North Seattle",
        "98126": "West Seattle / Delridge",
        "98133": "Northgate / Bitter Lake",
        "98134": "SoDo",
        "98136": "West Seattle / Fauntleroy",
        "98144": "Mount Baker / Central District",
        "98154": "Downtown",
        "98164": "Downtown",
        "98174": "Downtown",
        "98177": "North Beach / Crown Hill",
        "98194": "Downtown",
        "98199": "Magnolia",
      };

      const state = {
        rows: [],
        baseRows: [],
        filteredRows: [],
        interactions: {
          month: null,
          neighborhood: null,
          type: null,
          ratioBucket: null,
          mode: null,
          closeTier: null,
          psfTier: null,
        },
      };

      function esc(v) {
        return String(v ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function toDate(value) {
        if (!value) return null;
        const raw = String(value).trim();
        if (!raw) return null;
        const iso = /^\d{4}-\d{2}-\d{2}$/;
        const d = iso.test(raw) ? new Date(`${raw}T00:00:00`) : new Date(raw);
        return Number.isNaN(d.getTime()) ? null : d;
      }

      function toIso(value) {
        const d = toDate(value);
        if (!d) return "";
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
      }

      function num(v) {
        if (v === null || v === undefined || v === "") return 0;
        const n = Number(String(v).replace(/[^0-9.-]/g, ""));
        return Number.isFinite(n) ? n : 0;
      }

      function formatMoney(v) {
        return Number(v || 0).toLocaleString("en-US", {
          style: "currency",
          currency: "USD",
          maximumFractionDigits: 0,
        });
      }

      function median(values) {
        if (!values.length) return 0;
        const sorted = [...values].sort((a, b) => a - b);
        const mid = Math.floor(sorted.length / 2);
        return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
      }

      function quantile(values, q) {
        if (!values.length) return 0;
        const sorted = [...values].sort((a, b) => a - b);
        const pos = (sorted.length - 1) * q;
        const base = Math.floor(pos);
        const rest = pos - base;
        if (sorted[base + 1] !== undefined) {
          return sorted[base] + rest * (sorted[base + 1] - sorted[base]);
        }
        return sorted[base];
      }

      function monthKey(isoDate) {
        const d = toDate(isoDate);
        if (!d) return "Unknown";
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
      }

      function daysBetween(a, b) {
        const d1 = toDate(a);
        const d2 = toDate(b);
        if (!d1 || !d2) return null;
        return Math.round((d2 - d1) / (1000 * 60 * 60 * 24));
      }

      function parseCsvLine(line) {
        const out = [];
        let cur = "";
        let inQuotes = false;
        for (let i = 0; i < line.length; i += 1) {
          const ch = line[i];
          if (ch === '"') {
            if (inQuotes && line[i + 1] === '"') {
              cur += '"';
              i += 1;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (ch === "," && !inQuotes) {
            out.push(cur.trim());
            cur = "";
          } else {
            cur += ch;
          }
        }
        out.push(cur.trim());
        return out;
      }

      function parseCsv(text) {
        const lines = text.trim().split(/\r?\n/);
        if (lines.length < 2) return [];
        const headers = parseCsvLine(lines[0]);
        const idx = Object.fromEntries(headers.map((h, i) => [h, i]));

        const required = ["id", "address", "type", "closePrice"];
        const missing = required.filter((k) => idx[k] === undefined);
        if (missing.length) throw new Error(`Missing required columns: ${missing.join(", ")}`);

        return lines.slice(1).filter((line) => line.trim()).map((line) => {
          const cols = parseCsvLine(line);
          const pick = (name) => (idx[name] !== undefined ? (cols[idx[name]] || "").trim() : "");
          return {
            dataMode: pick("dataMode"),
            id: pick("id"),
            address: pick("address"),
            neighborhood: pick("neighborhood"),
            type: pick("type"),
            typeCode: pick("typeCode"),
            listDate: pick("listDate"),
            pendingDate: pick("pendingDate"),
            saleDate: pick("saleDate"),
            listPriceAtPending: num(pick("listPriceAtPending")),
            closePrice: num(pick("closePrice")),
            assessedValue: num(pick("assessedValue")),
            beds: num(pick("beds")),
            baths: num(pick("baths")),
            sqft: num(pick("sqft")),
            yearBuilt: num(pick("yearBuilt")),
            zip: pick("zip"),
            mlsListDate: pick("mlsListDate"),
            mlsPendingDate: pick("mlsPendingDate"),
            mlsListPriceAtPending: num(pick("mlsListPriceAtPending")),
            mlsClosePrice: num(pick("mlsClosePrice")),
          };
        });
      }

      function titleCase(text) {
        return String(text || "")
          .toLowerCase()
          .replace(/\b\w/g, (m) => m.toUpperCase());
      }

      function inferMode(row) {
        if (row.dataMode) return row.dataMode;
        const hasMls = row.mlsListDate || row.mlsPendingDate || row.mlsListPriceAtPending || row.mlsClosePrice;
        return hasMls ? "MLS_ENRICHED" : "PUBLIC_PROXY";
      }

      function labelNeighborhood(rawNeighborhood, zip) {
        const raw = String(rawNeighborhood || "").trim();
        if (/[a-z]/i.test(raw)) return raw;
        const z = (String(zip || "").match(/[0-9]{5}/) || [])[0] || "";
        return ZIP_NEIGHBORHOOD[z] || "Seattle (Other)";
      }

      function labelType(rawType, typeCode) {
        const raw = String(rawType || "").trim();
        if (/[a-z]/i.test(raw)) {
          if (/^[A-Z0-9\s,()\-]+$/.test(raw)) return titleCase(raw);
          return raw;
        }
        const code = String(num(typeCode || raw) || "");
        return TYPE_LABELS[code] || (code ? `Type ${code}` : "Unknown");
      }

      function normalizeRow(source) {
        const dataMode = inferMode(source);
        const saleDate = source.saleDate || source.pendingDate || source.listDate || "";
        const listDate = source.mlsListDate || source.listDate || "";
        const pendingDate = source.mlsPendingDate || source.pendingDate || "";

        const closePrice = num(source.mlsClosePrice || source.closePrice);
        const assessedValue = num(source.assessedValue);
        const listPriceAtPending = num(source.mlsListPriceAtPending || source.listPriceAtPending || assessedValue || closePrice);

        const daysToPending = daysBetween(listDate, pendingDate);
        const saleToAssessed = assessedValue > 0 ? closePrice / assessedValue : 0;
        const delta = closePrice - listPriceAtPending;
        const deltaPct = listPriceAtPending > 0 ? delta / listPriceAtPending : 0;
        const sqft = num(source.sqft);
        const pricePerSqft = sqft > 0 ? closePrice / sqft : 0;

        return {
          ...source,
          dataMode,
          typeLabel: labelType(source.type, source.typeCode),
          neighborhoodLabel: labelNeighborhood(source.neighborhood, source.zip),
          saleDate: toIso(saleDate),
          listDate: toIso(listDate),
          pendingDate: toIso(pendingDate),
          closePrice,
          assessedValue,
          listPriceAtPending,
          beds: num(source.beds),
          baths: num(source.baths),
          sqft,
          yearBuilt: num(source.yearBuilt),
          daysToPending,
          saleToAssessed,
          delta,
          deltaPct,
          pricePerSqft,
        };
      }

      function uniqueValues(rows, key) {
        return ["All", ...Array.from(new Set(rows.map((r) => r[key]).filter(Boolean))).sort()];
      }

      function refreshSelectOptions() {
        const normalized = state.rows.map(normalizeRow);
        const neighborhoods = uniqueValues(normalized, "neighborhoodLabel");
        const types = uniqueValues(normalized, "typeLabel");

        const nSelect = document.getElementById("fNeighborhood");
        const tSelect = document.getElementById("fType");

        const currentN = nSelect.value || "All";
        const currentT = tSelect.value || "All";

        nSelect.innerHTML = neighborhoods.map((v) => `<option value="${esc(v)}">${esc(v)}</option>`).join("");
        tSelect.innerHTML = types.map((v) => `<option value="${esc(v)}">${esc(v)}</option>`).join("");

        nSelect.value = neighborhoods.includes(currentN) ? currentN : "All";
        tSelect.value = types.includes(currentT) ? currentT : "All";
      }

      function readFormFilters() {
        return {
          neighborhood: document.getElementById("fNeighborhood").value,
          type: document.getElementById("fType").value,
          mode: document.getElementById("fMode").value,
          scope: document.getElementById("fScope").value,
          minClose: num(document.getElementById("fMinClose").value),
          maxClose: num(document.getElementById("fMaxClose").value),
          dateFrom: document.getElementById("fDateFrom").value,
          dateTo: document.getElementById("fDateTo").value,
        };
      }

      function computeBaseRows() {
        const f = readFormFilters();
        let rows = state.rows.map(normalizeRow).filter((r) => r.closePrice > 0 && !!r.saleDate);

        if (f.neighborhood !== "All") rows = rows.filter((r) => r.neighborhoodLabel === f.neighborhood);
        if (f.type !== "All") rows = rows.filter((r) => r.typeLabel === f.type);
        if (f.mode !== "All") rows = rows.filter((r) => r.dataMode === f.mode);
        if (f.minClose) rows = rows.filter((r) => r.closePrice >= f.minClose);
        if (f.maxClose) rows = rows.filter((r) => r.closePrice <= f.maxClose);
        if (f.dateFrom) rows = rows.filter((r) => r.saleDate >= f.dateFrom);
        if (f.dateTo) rows = rows.filter((r) => r.saleDate <= f.dateTo);

        if (f.scope === "pending7") {
          rows = rows.filter((r) => r.dataMode === "MLS_ENRICHED" && r.daysToPending !== null && r.daysToPending <= 7);
        }

        return rows;
      }

      function computeBaseStats(rows) {
        return {
          medianClose: median(rows.map((r) => r.closePrice)),
          medianPsf: median(rows.filter((r) => r.pricePerSqft > 0).map((r) => r.pricePerSqft)),
        };
      }

      function inRatioBucket(value, key) {
        if (key === "lt095") return value > 0 && value < 0.95;
        if (key === "095to100") return value >= 0.95 && value < 1.0;
        if (key === "100to105") return value >= 1.0 && value <= 1.05;
        if (key === "gt105") return value > 1.05;
        if (key === "gt100") return value > 1.0;
        return true;
      }

      function applyInteractions(baseRows, stats) {
        const i = state.interactions;
        return baseRows.filter((r) => {
          if (i.month && monthKey(r.saleDate) !== i.month) return false;
          if (i.neighborhood && r.neighborhoodLabel !== i.neighborhood) return false;
          if (i.type && r.typeLabel !== i.type) return false;
          if (i.mode && r.dataMode !== i.mode) return false;
          if (i.ratioBucket && !inRatioBucket(r.saleToAssessed, i.ratioBucket)) return false;
          if (i.closeTier === "aboveMedian" && r.closePrice < stats.medianClose) return false;
          if (i.psfTier === "aboveMedian") {
            if (r.pricePerSqft <= 0 || r.pricePerSqft < stats.medianPsf) return false;
          }
          return true;
        });
      }

      function interactionLabel(key, value) {
        const titles = {
          month: "Month",
          neighborhood: "Neighborhood",
          type: "Type",
          ratioBucket: "Ratio",
          mode: "Mode",
          closeTier: "Close Price",
          psfTier: "Price/SqFt",
        };
        const values = {
          lt095: "< 0.95x",
          "095to100": "0.95x - 1.00x",
          "100to105": "1.00x - 1.05x",
          gt105: "> 1.05x",
          gt100: "> 1.00x",
          aboveMedian: "Above Median",
        };
        return `${titles[key] || key}: ${values[value] || value}`;
      }

      function renderChips() {
        const entries = Object.entries(state.interactions).filter(([, v]) => v);
        const el = document.getElementById("activeChips");
        if (!entries.length) {
          el.innerHTML = `<span class="chip">No cross-filters active</span>`;
          return;
        }
        el.innerHTML = entries.map(([k, v]) => {
          return `<span class="chip">${esc(interactionLabel(k, v))}<button type="button" data-clear-interaction="${esc(k)}">x</button></span>`;
        }).join("");
      }

      function renderSummary(filtered, baseRows) {
        const mls = filtered.filter((r) => r.dataMode === "MLS_ENRICHED").length;
        const pub = filtered.length - mls;
        document.getElementById("filterSummary").textContent =
          `Base rows: ${baseRows.length} | Current slice: ${filtered.length} | Public Proxy: ${pub} | MLS Enriched: ${mls}`;
      }

      function renderKpis(rows, stats) {
        const ratios = rows.filter((r) => r.saleToAssessed > 0).map((r) => r.saleToAssessed);
        const psf = rows.filter((r) => r.pricePerSqft > 0).map((r) => r.pricePerSqft);
        const mlsPending = rows.filter((r) => r.dataMode === "MLS_ENRICHED" && r.daysToPending !== null).map((r) => r.daysToPending);

        document.getElementById("kSales").textContent = rows.length;
        document.getElementById("kMedianClose").textContent = formatMoney(median(rows.map((r) => r.closePrice)));
        document.getElementById("kMedianSA").textContent = `${median(ratios).toFixed(2)}x`;
        const above = ratios.length ? (ratios.filter((v) => v > 1).length / ratios.length) * 100 : 0;
        document.getElementById("kAboveAssessed").textContent = `${above.toFixed(1)}%`;
        document.getElementById("kPsf").textContent = formatMoney(median(psf));
        document.getElementById("kPendingDays").textContent = mlsPending.length ? `${median(mlsPending).toFixed(0)} days` : "n/a";

        document.querySelectorAll(".kbtn").forEach((b) => b.classList.remove("active"));
        if (state.interactions.closeTier === "aboveMedian") document.querySelector('[data-kpi-action="closeTier"]').classList.add("active");
        if (state.interactions.ratioBucket === "100to105") document.querySelector('[data-kpi-action="ratioMid"]').classList.add("active");
        if (state.interactions.ratioBucket === "gt100") document.querySelector('[data-kpi-action="ratioGt1"]').classList.add("active");
        if (state.interactions.psfTier === "aboveMedian") document.querySelector('[data-kpi-action="psfTier"]').classList.add("active");
        if (state.interactions.mode === "MLS_ENRICHED") document.querySelector('[data-kpi-action="mlsOnly"]').classList.add("active");
      }

      function renderInsights(rows) {
        const el = document.getElementById("insights");
        if (!rows.length) {
          el.innerHTML = `<li>No rows match current filters. Widen criteria or clear cross-filters.</li>`;
          return;
        }

        const ratios = rows.filter((r) => r.saleToAssessed > 0).map((r) => r.saleToAssessed);
        const overShare = ratios.length ? (ratios.filter((v) => v > 1).length / ratios.length) * 100 : 0;

        const byNeighborhood = {};
        rows.forEach((r) => { byNeighborhood[r.neighborhoodLabel] = (byNeighborhood[r.neighborhoodLabel] || 0) + 1; });
        const topNeighborhood = Object.entries(byNeighborhood).sort((a, b) => b[1] - a[1])[0];

        const byMonth = {};
        rows.forEach((r) => {
          const m = monthKey(r.saleDate);
          byMonth[m] = (byMonth[m] || 0) + 1;
        });
        const topMonth = Object.entries(byMonth).sort((a, b) => b[1] - a[1])[0];

        const lines = [
          `Median close price is ${formatMoney(median(rows.map((r) => r.closePrice)))} across ${rows.length} homes in this slice.`,
          `${overShare.toFixed(1)}% of homes closed above assessed value (median S/A ${median(ratios).toFixed(2)}x).`,
          `Highest activity is ${topNeighborhood ? topNeighborhood[0] : "n/a"} (${topNeighborhood ? topNeighborhood[1] : 0} sales).`,
          `Most active month is ${topMonth ? topMonth[0] : "n/a"} (${topMonth ? topMonth[1] : 0} sales).`,
        ];

        const mlsRows = rows.filter((r) => r.dataMode === "MLS_ENRICHED" && r.daysToPending !== null);
        if (mlsRows.length) {
          lines.push(`MLS-enriched subset median days-to-pending: ${median(mlsRows.map((r) => r.daysToPending)).toFixed(0)} days.`);
        } else {
          lines.push("No MLS-enriched rows in this slice, so true list/pending timing is unavailable here.");
        }

        lines.push("Color scales cap outlier influence at robust percentile bounds (5th-95th).\n");
        el.innerHTML = lines.map((line) => `<li>${esc(line)}</li>`).join("");
      }

      function renderBarChart(containerId, items, valueFn, labelFn, tailFn, warm) {
        const container = document.getElementById(containerId);
        if (!items.length) {
          container.innerHTML = `<div class="note">No rows for current filters.</div>`;
          return;
        }

        const robustTop = Math.max(quantile(items.map((i) => valueFn(i)), 0.95), 1);
        container.innerHTML = items.map((item) => {
          const width = Math.min(100, Math.round((valueFn(item) / robustTop) * 100));
          const active = state.interactions.month === item.month;
          return `
            <button class="bar-row ${active ? "active" : ""}" data-set-interaction="month" data-set-value="${esc(item.month)}" type="button">
              <span>${esc(labelFn(item))}</span>
              <span class="track"><span class="fill ${warm ? "warm" : ""}" style="width:${width}%"></span></span>
              <span>${esc(tailFn(item))}</span>
            </button>
          `;
        }).join("");
      }

      function renderCharts(rows) {
        const volume = {};
        rows.forEach((r) => {
          const m = monthKey(r.saleDate);
          if (!volume[m]) volume[m] = { month: m, count: 0 };
          volume[m].count += 1;
        });
        const volumeRows = Object.values(volume).sort((a, b) => a.month.localeCompare(b.month));
        renderBarChart("chartVolume", volumeRows, (x) => x.count, (x) => x.month, (x) => `${x.count} sales`, false);

        const price = {};
        rows.forEach((r) => {
          const m = monthKey(r.saleDate);
          if (!price[m]) price[m] = [];
          price[m].push(r.closePrice);
        });
        const priceRows = Object.entries(price)
          .map(([month, vals]) => ({ month, medianPrice: median(vals) }))
          .sort((a, b) => a.month.localeCompare(b.month));
        renderBarChart("chartMedian", priceRows, (x) => x.medianPrice, (x) => x.month, (x) => formatMoney(x.medianPrice), true);
      }

      function renderRatioRows(rows) {
        const tbody = document.getElementById("ratioRows");
        if (!rows.length) {
          tbody.innerHTML = `<tr><td colspan="4">No rows for current filters.</td></tr>`;
          return;
        }

        const buckets = [
          { key: "lt095", label: "< 0.95x" },
          { key: "095to100", label: "0.95x - 1.00x" },
          { key: "100to105", label: "1.00x - 1.05x" },
          { key: "gt105", label: "> 1.05x" },
        ];

        const total = rows.length;
        tbody.innerHTML = buckets.map((b) => {
          const set = rows.filter((r) => inRatioBucket(r.saleToAssessed, b.key));
          const share = total ? ((set.length / total) * 100).toFixed(1) : "0.0";
          const active = state.interactions.ratioBucket === b.key;
          return `
            <tr class="clickable ${active ? "active" : ""}" data-set-interaction="ratioBucket" data-set-value="${esc(b.key)}">
              <td>${esc(b.label)}</td>
              <td>${set.length}</td>
              <td>${share}%</td>
              <td>${formatMoney(median(set.map((r) => r.closePrice)))}</td>
            </tr>
          `;
        }).join("");
      }

      function renderRankRows(rows) {
        const tbody = document.getElementById("rankRows");
        if (!rows.length) {
          tbody.innerHTML = `<tr><td colspan="4">No rows for current filters.</td></tr>`;
          return;
        }

        const grouped = {};
        rows.forEach((r) => {
          if (!grouped[r.neighborhoodLabel]) grouped[r.neighborhoodLabel] = [];
          grouped[r.neighborhoodLabel].push(r);
        });

        const rank = Object.entries(grouped)
          .map(([name, set]) => ({
            name,
            count: set.length,
            medianClose: median(set.map((r) => r.closePrice)),
            medianRatio: median(set.filter((r) => r.saleToAssessed > 0).map((r) => r.saleToAssessed)),
          }))
          .sort((a, b) => (b.count - a.count) || (b.medianClose - a.medianClose))
          .slice(0, 18);

        tbody.innerHTML = rank.map((r) => {
          const active = state.interactions.neighborhood === r.name;
          return `
            <tr class="clickable ${active ? "active" : ""}" data-set-interaction="neighborhood" data-set-value="${esc(r.name)}">
              <td>${esc(r.name)}</td>
              <td>${r.count}</td>
              <td>${formatMoney(r.medianClose)}</td>
              <td>${r.medianRatio.toFixed(2)}x</td>
            </tr>
          `;
        }).join("");
      }

      function seqScale(values) {
        if (!values.length) return () => 0;
        const low = quantile(values, 0.05);
        const high = quantile(values, 0.95);
        const span = Math.max(high - low, 1);
        return (v) => {
          const clamped = Math.max(low, Math.min(high, v));
          return (clamped - low) / span;
        };
      }

      function divScale(values) {
        const abs = values.map((v) => Math.abs(v)).filter((v) => v > 0);
        if (!abs.length) return () => 0;
        const cap = Math.max(quantile(abs, 0.95), 1);
        return (v) => Math.max(-1, Math.min(1, v / cap));
      }

      function seqHeat(norm, color) {
        const pct = Math.round(Math.max(0, Math.min(1, norm)) * 100);
        return `background: linear-gradient(90deg, ${color} ${pct}%, rgba(255,255,255,0.03) ${pct}%);`;
      }

      function divHeat(norm) {
        const pct = Math.round(Math.max(0, Math.min(1, Math.abs(norm))) * 100);
        const color = norm >= 0 ? "rgba(61, 213, 157, 0.34)" : "rgba(230, 113, 140, 0.34)";
        return `background: linear-gradient(90deg, ${color} ${pct}%, rgba(255,255,255,0.03) ${pct}%);`;
      }

      function zillowUrl(row) {
        const q = encodeURIComponent(`${row.address} Seattle WA ${row.zip || ""}`.trim());
        return `https://www.zillow.com/homes/${q}_rb/`;
      }

      function renderRecordRows(rows) {
        const tbody = document.getElementById("recordRows");
        if (!rows.length) {
          tbody.innerHTML = `<tr><td colspan="12">No rows for current filters.</td></tr>`;
          return;
        }

        const closeNorm = seqScale(rows.map((r) => r.closePrice));
        const ratioNorm = seqScale(rows.filter((r) => r.saleToAssessed > 0).map((r) => r.saleToAssessed));
        const deltaNorm = divScale(rows.map((r) => r.delta));

        tbody.innerHTML = rows
          .slice()
          .sort((a, b) => b.saleDate.localeCompare(a.saleDate))
          .map((r) => {
            const nActive = state.interactions.neighborhood === r.neighborhoodLabel;
            const tActive = state.interactions.type === r.typeLabel;
            const mActive = state.interactions.month === monthKey(r.saleDate);
            return `
              <tr>
                <td><a href="${esc(zillowUrl(r))}" target="_blank" rel="noopener noreferrer">${esc(r.address)}</a></td>
                <td><button class="mini-btn ${nActive ? "active" : ""}" data-set-interaction="neighborhood" data-set-value="${esc(r.neighborhoodLabel)}">${esc(r.neighborhoodLabel)}</button></td>
                <td><button class="mini-btn ${tActive ? "active" : ""}" data-set-interaction="type" data-set-value="${esc(r.typeLabel)}">${esc(r.typeLabel)}</button></td>
                <td>${r.beds || 0}</td>
                <td>${r.baths ? r.baths.toFixed(2) : "0.00"}</td>
                <td>${r.sqft ? r.sqft.toLocaleString("en-US") : "0"}</td>
                <td><button class="mini-btn ${mActive ? "active" : ""}" data-set-interaction="month" data-set-value="${esc(monthKey(r.saleDate))}">${esc(r.saleDate || "n/a")}</button></td>
                <td><span class="heat" style="${seqHeat(closeNorm(r.closePrice), "rgba(77,166,255,0.33)")}">${formatMoney(r.closePrice)}</span></td>
                <td>${formatMoney(r.assessedValue)}</td>
                <td><span class="heat" style="${seqHeat(r.saleToAssessed > 0 ? ratioNorm(r.saleToAssessed) : 0, "rgba(61,213,157,0.33)")}">${r.saleToAssessed > 0 ? `${r.saleToAssessed.toFixed(2)}x` : "n/a"}</span></td>
                <td><span class="heat" style="${divHeat(deltaNorm(r.delta))}">${formatMoney(r.delta)}</span></td>
                <td><span class="mode">${esc(r.dataMode)}</span></td>
              </tr>
            `;
          })
          .join("");
      }

      function renderAll() {
        const baseRows = computeBaseRows();
        state.baseRows = baseRows;
        const stats = computeBaseStats(baseRows);
        const filtered = applyInteractions(baseRows, stats);
        state.filteredRows = filtered;

        renderSummary(filtered, baseRows);
        renderChips();
        renderKpis(filtered, stats);
        renderInsights(filtered);
        renderCharts(filtered);
        renderRatioRows(filtered);
        renderRankRows(filtered);
        renderRecordRows(filtered);
      }

      function setInteraction(key, value) {
        state.interactions[key] = state.interactions[key] === value ? null : value;
        renderAll();
      }

      function clearCrossFilters() {
        Object.keys(state.interactions).forEach((k) => { state.interactions[k] = null; });
        renderAll();
      }

      function resetFormFilters() {
        document.getElementById("fNeighborhood").value = "All";
        document.getElementById("fType").value = "All";
        document.getElementById("fMode").value = "All";
        document.getElementById("fScope").value = "all";
        document.getElementById("fMinClose").value = "";
        document.getElementById("fMaxClose").value = "";
        document.getElementById("fDateFrom").value = "";
        document.getElementById("fDateTo").value = "";
      }

      function escapeCsv(v) {
        const s = String(v ?? "");
        if (s.includes(",") || s.includes('"') || s.includes("\n")) return `"${s.replace(/"/g, '""')}"`;
        return s;
      }

      function exportFilteredCsv() {
        if (!state.filteredRows.length) return;
        const headers = [
          "id","address","neighborhood","type","dataMode","saleDate","listDate","pendingDate",
          "closePrice","assessedValue","saleToAssessed","listPriceAtPending","delta","deltaPct",
          "beds","baths","sqft","yearBuilt","zip"
        ];
        const lines = [headers.join(",")];
        state.filteredRows.forEach((r) => {
          lines.push([
            r.id,
            r.address,
            r.neighborhoodLabel,
            r.typeLabel,
            r.dataMode,
            r.saleDate,
            r.listDate,
            r.pendingDate,
            r.closePrice,
            r.assessedValue,
            r.saleToAssessed,
            r.listPriceAtPending,
            r.delta,
            r.deltaPct,
            r.beds,
            r.baths,
            r.sqft,
            r.yearBuilt,
            r.zip,
          ].map(escapeCsv).join(","));
        });

        const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "seattle_buyer_lens_filtered.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function bindEvents() {
        ["fNeighborhood", "fType", "fMode", "fScope", "fMinClose", "fMaxClose", "fDateFrom", "fDateTo"].forEach((id) => {
          const el = document.getElementById(id);
          el.addEventListener("input", renderAll);
          el.addEventListener("change", renderAll);
        });

        document.getElementById("resetBtn").addEventListener("click", () => {
          resetFormFilters();
          renderAll();
        });
        document.getElementById("clearCrossBtn").addEventListener("click", clearCrossFilters);
        document.getElementById("exportCsvBtn").addEventListener("click", exportFilteredCsv);

        document.querySelectorAll(".tab").forEach((btn) => {
          btn.addEventListener("click", () => {
            document.querySelectorAll(".tab").forEach((x) => x.classList.remove("active"));
            btn.classList.add("active");
            const target = btn.getAttribute("data-view");
            document.querySelectorAll(".view").forEach((v) => v.classList.toggle("active", v.id === `view-${target}`));
          });
        });

        document.addEventListener("click", (evt) => {
          const set = evt.target.closest("[data-set-interaction]");
          if (set) {
            setInteraction(set.getAttribute("data-set-interaction"), set.getAttribute("data-set-value"));
            return;
          }

          const clear = evt.target.closest("[data-clear-interaction]");
          if (clear) {
            const key = clear.getAttribute("data-clear-interaction");
            state.interactions[key] = null;
            renderAll();
            return;
          }

          const kpi = evt.target.closest("[data-kpi-action]");
          if (!kpi) return;
          const action = kpi.getAttribute("data-kpi-action");
          if (action === "clear") return clearCrossFilters();
          if (action === "closeTier") return setInteraction("closeTier", "aboveMedian");
          if (action === "ratioMid") return setInteraction("ratioBucket", "100to105");
          if (action === "ratioGt1") return setInteraction("ratioBucket", "gt100");
          if (action === "psfTier") return setInteraction("psfTier", "aboveMedian");
          if (action === "mlsOnly") return setInteraction("mode", "MLS_ENRICHED");
        });

        document.getElementById("csvFile").addEventListener("change", (evt) => {
          const file = evt.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            try {
              state.rows = parseCsv(reader.result);
              refreshSelectOptions();
              clearCrossFilters();
              renderAll();
              document.getElementById("uploadStatus").textContent = `Loaded ${state.rows.length} rows from ${file.name}.`;
              document.getElementById("datasetStatus").textContent = `Using uploaded dataset: ${file.name} (${state.rows.length} rows).`;
            } catch (err) {
              document.getElementById("uploadStatus").textContent = `Upload failed: ${err.message}`;
            }
          };
          reader.readAsText(file);
        });
      }

      async function autoLoadDefault() {
        const status = document.getElementById("datasetStatus");
        try {
          const response = await fetch(DEFAULT_DATASET, { cache: "no-store" });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const text = await response.text();
          state.rows = parseCsv(text);
          refreshSelectOptions();
          renderAll();
          document.getElementById("uploadStatus").textContent = `Auto-loaded ${DEFAULT_DATASET}.`;
          status.textContent = `Auto-loaded ${DEFAULT_DATASET} (${state.rows.length} rows).`;
        } catch (err) {
          state.rows = [];
          refreshSelectOptions();
          renderAll();
          status.textContent = "Auto-load unavailable. Serve over HTTP (scripts/serve.js) or upload CSV in Data tab.";
        }
      }

      function init() {
        bindEvents();
        autoLoadDefault();
      }

      init();
    </script>
  </body>
</html>
